var COMMON=function(){function a(a,b){var c=30,d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3),document.cookie=a+"="+escape(b)+";expires="+d.toGMTString()}function b(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function c(a){if(-1===x.indexOf("?")||-1===x.indexOf(a+"="))return"";var b=x.substring(x.indexOf("?")+1);-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#")));for(var c,d,e,f=b.split("&"),g=0;g<f.length;g++)if(c=f[g].indexOf("="),-1!==c&&(d=f[g].substring(0,c),e=f[g].substring(c+1),d===a))return e.replace(/\+/g," ");return""}function d(a){var b=[];l({url:"listTeams.do",obj:{},callback:function(c){if(1==c.code){for(var d=c.data||[],e=0,f=d.length;f>e;e++)b.push({text:d[e],value:d[e]});a.selected=d[0],a.options=b}}})}function e(){var a=avalon.define("series",function(a){a.tr=[],a.getCon=function(){h(a,"listVehicleTypeByPage.do")},a.saveItem=function(){i("series")}});a.getCon()}function f(){var a=avalon.define("brand",function(a){a.tr=[],a.getCon=function(){h(a,"listBrandByPage.do");$.extend({},w)},a.saveItem=function(){i("brand")}});a.getCon()}function g(){var a=avalon.define("fuwushang",function(a){a.tr=[],a.getCon=function(){h(a,"facilitatorList.do")},a.saveItem=function(){i("facilitatorList")}});a.getCon()}function h(a,b){var c=$.extend({},w);l({url:b,obj:c,callback:function(c){if(1==c.code){var d=c.data||{};"facilitatorList.do"==b?a.tr=d:a.tr=d.data||{}}}})}function i(a){var b=[],c=[],d=$("input:checked",$("div."+a)),e=$("div.winpop");if("radio"==d.attr("type"))$("#"+a).val(d.val()).attr("data-value",d.attr("data-value"));else{for(var f=0,g=d.length;g>f;f++)b.push(d.eq(f).val()),c.push(d.eq(f).attr("data-value"));$("#"+a).val(b.join(";")).attr("data-value",c)}e.hide(),z.hide()}function j(a,b){var c=function(){function b(a,b,d){b=$.extend({},w,b||{}),curpage=b.pageNum,b.pageSize=10,l({url:a,obj:b,callback:function(e){if(1==e.code||1==e.ret){var f=e.data||{},h=null,i=$("tr.loading",$("div[avalonctrl="+g.$id+"]"));if("[object Array]"==r.call(f)){if(!(f.length>0))return g.nodata="暂无数据",void i.show();h=f}else if("[object Object]"==r.call(f)){if(!e.data)return g.nodata="暂无数据",void i.show();if(!e.data.data)return g.nodata="暂无数据",void i.show();h=f.data||{}}if(i.hide(),x.indexOf("yuyuejiedai")>-1)for(var j,k=0,l=h.length;l>k;k++)j=h[k],j.maintainform&&(h[k]=$.extend({},j.maintainform||{},j));if(g.tr=[],g.tr=h||{},"function"==typeof d&&d(g),pageTotal=e.data.total||"",pageTotal&&1!=pageTotal){$("div.page").show();var m=pageTotal,n=$("div.page");n.pager({pageNumber:curpage,pageTotal:m,change:function(d){b.pageNum=d,c(a,b,function(){g.getNum(d)})}})}else $("div.page").hide()}}})}function c(a,c,d){b(a,c,d)}var d=a.id||"table",e=a.param,f=a.id||"model",g=avalon.define(f,function(c){c.$id=d,c.itemId=a.itemId,c.th=a.th,c.tr=[],c.isOpt=a.isOpt===!1?!1:!0,c.isCheck=a.isCheck===!0?!0:!1,c.nodata='<img src="img/loading.gif"/>',c.pageClass=a.pageClass||"pager",c.getkey=function(a,b,d){if(x.indexOf("index.html")>-1&&"state"==b)return'<img src="img/status'+c.tr[a][b]+'.png" />';if(c.tr.size()>0&&c.tr[a]){if(!d)return c.tr[a][b];for(var e=0,f=d.length;f>e;e++){if(d.th[e]&&d.th[e].time){var g=c.tr[a][b];return new Date(g).toLocaleDateString()}if(c.tr[a][b]==d[e].value)return d[c.tr[a][b]].text}}},c.getId=function(b,e){var f=c;if(f.tr.length>0&&f.tr[b]&&1!=a.btntype){var g=x.split("/"),h=g[g.length-1].split(".html")[0]||"index";if(x.indexOf("caiwuguanli.html")>-1){var i=0;return i="tablesingle"==d?0:1,h+"-opt.html?id="+f.tr[b][f.itemId]+"&type="+i}return h+"-opt.html?id="+f.tr[b][f.itemId]}},c.getNum=function(a){for(var b=$("tr",$("table.Mtable")),c=null,d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},c.delItem=function(b){var d=c.tr[b][a.itemId],f={};y.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(b){x.indexOf("weixiujiedai")>-1?f.mainId=d:f[a.itemId]=d,f=$.extend({},w,f),l({url:a.delport,obj:f,callback:function(d){1==d.code&&(b.dialog("hide"),c.getTr(a.port,e,a.callback))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},c.addItem=function(){if(1==a.btntype)$("div.dialog").dialog("show"),"function"==typeof a.callback&&a.callback();else{var b=x.split("/"),c=b[b.length-1].split(".html")[0]||"index";x.indexOf("weixiujiedai")>-1?l({url:a.addport,obj:{},callback:function(a){1==a.code&&(location.href=c+"-opt.html?id="+a.data.mainId)}}):location.href=c+"-opt.html"}},c.getTr=function(){b(a.port,e,a.callback)},c.searchItem=function(){var b=$("div.search");e[$("span.select",b).attr("data-id")]=$("input.inpt-search",b).val(),c.getTr(a.port,e,a.callback)},c.saveItem=function(){"function"==typeof a.callback&&a.callback(c)}});avalon.scan()};c()}function k(a,b){var a=a||"edit",d=null,e={},f={status:0};if((x.indexOf("xitongguanli")>-1||x.indexOf("caiwuguanli")>-1)&&(f={}),f[b.itemId]=c("id"),$("a.btn-return").on("click",function(){var a=c("type"),b="";a&&(b="?type="+a),location.href=x.substr(0,x.lastIndexOf("-opt"))+".html"+b}),d=avalon.define({$id:a,item:b.editItem,newData:e,isJump:!1,getNewData:function(){for(var a,c=b.editItem,d="",f=0,g=c.length;g>f;f++)a=c[f],d=e[a.id],a.selected||0==a.selected?d=d?d:a.selected:"time"==a.dataType?$("#"+a.id).datetimepicker({lang:"zh",i18n:{de:{months:s.MONTH,dayOfWeek:s.WEEK}},format:"Y/m/d h:m",value:d?new Date(d).toLocaleDateString():(new Date).toLocaleDateString(),closeOnTimeSelect:!0,onShow:function(a){}}):"date"==a.dataType?$("#"+a.id).datetimepicker({lang:"zh",i18n:{de:{months:s.MONTH,dayOfWeek:s.WEEK}},format:"Y/m/d",value:d?new Date(d).toLocaleDateString():(new Date).toLocaleDateString(),closeOnDateSelect:!0,onShow:function(a){},timepicker:!1}):d=d?d:a.value},change:function(a){a.target.getAttribute("data-id")==b.itemId?e.mainId=a.target.value:e[a.target.getAttribute("data-id")]=a.target.value},flag:!0,blur:function(a,c){var e=d,f=b.editItem,g=c.target.value,h=$(c.target),i=h.parent(),j=f[a].dataType,k="";if(j)if("name"==j?v.name.test(g)||(k="请输入真实姓名",e.flag=!1):"phone"==j?v.phone.test(g)||(k="请输入正确的手机格式",e.flag=!1):"tel"==j?v.tel.test(g)||(k="请输入正确的固定电话格式",e.flag=!1):"email"==j?v.email.test(g)||(k="请输入正确的邮箱格式",e.flag=!1):"number"==j?v.num.test(g)||(k="请输入数字格式",e.flag=!1):"plate"==j?v.plate.test(g)||(k="请输入正确的车牌号",e.flag=!1):"idcard"==j&&(v.idcard.test(g)||(k="请输入15或18位的身份证号",e.flag=!1)),k){if($("div.error",i).size()>0)return void $("div.error",i).show();i.append('<div class="error">'+k+"</div>")}else $("div.error",i).hide(),e.flag=!0},data:[],dialogData:function(a){b.editItem[a].click&&b.editItem[a].click(b.editItem[a].id,d)},addItem:function(){var a=b.addurl||b.addport;if(a)l({url:a,obj:w,callback:function(a){if(1==a.code){var c=b.itemId,f=a.data||{};e={},e[c]=f[c]||"&nbsp;";for(var g=0,h=b.editItem.length;h>g;g++)b.editItem[g].value="";b.editItem[c]=f[c],d.item=b.editItem}}});else for(var c=0,f=b.editItem.length;f>c;c++)b.editItem[c].value="",e[b.editItem[c].name]=""},saveItem:function(){if(d.flag){d.modifyId();var a=b.editItem;if(x.indexOf("kehuguanli-opt")>-1){var f={};f.id=c("id"),f.carOwner=e.carOwner,f.carNum=e.carNum,f.carType=e.carType,e=f}c("id")&&(e[b.itemId]=c("id")),x.indexOf("yuyuejiedai-opt")>-1&&(e.mainId=c("id"),delete e[b.itemId]);for(var g=0,h=a.length;h>g;g++)if(!e[a[g].value]){if(b.id&&b.itemId==a[g].id)continue;e[a[g].id]=$("#"+a[g].id).val()}x.indexOf("gerenyuyue")>-1&&(e.status=0),l({url:b.saveurl||b.saveport,type:"POST",obj:e,callback:function(a){1==a.code?$("div.dialog").dialog({title:"提示",content:a.message||"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide"),x.indexOf("gerenyuyue")>-1?location.href=x:c("type")?location.href=(x.substring(0,x.indexOf("-opt"))||"index")+".html?type="+c("type"):location.href=(x.substring(0,x.indexOf("-opt"))||"index")+".html"}}],callback:function(a){a.addClass("w400")}}):$("div.dialog").dialog({title:"提示",content:a.message||"保存失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})}},cancelItem:function(){for(g in e)"maintainfortNum"==g&&(e.mainId=e[g],delete e[g]);l({url:b.cancelport,type:"POST",obj:e,callback:function(a){1==a.code?location.href=(x.substring(0,x.indexOf("-opt"))||"index")+".html":alert("取消失败")}})},modifyId:function(){(x.indexOf("index")>-1||x.indexOf("weixiujiedai")>-1)&&e.maintainfortNum&&(e.mainId=e.maintainfortNum),x.indexOf("chejianguanli")>-1&&e.appointmentNum&&(e.maintainID=e.appointmentNum)}}),c("id"))b.id&&(f[b.id]=c("id"),delete f[b.itemId]),x.indexOf("kufangguanli")>-1&&(f=$.extend({},{pageNumber:1,pageSize:10},f)),b.editurl||b.editport?l({url:b.editurl||b.editport,obj:f,callback:function(f){if(1==f.code||1==f.ret){var g=b.editItem,h="",i=f.data||{};if(!f.data)return void $("div.opt[avalonctrl="+a+"]").html("暂无数据").addClass("tc");if(b.edittype&&(i=i.length>0?i[0]||{}:i.data[0]||{}),x.indexOf("yuyuejiedai")>-1&&(i=$.extend({},i.maintainform||{},i)),i){for(var j=d.item,k=null,l=0,m=g.length;m>l;l++)k=j[l],h=g[l].id,(x.indexOf("index")>-1||x.indexOf("weixiujiedai")>-1)&&"maintainfortNum"==h?(editItemVal=c("id"),k.value=editItemVal,e.mainId=editItemVal):(editItemVal=i[h],k.value=editItemVal,e[h]=editItemVal,g[l].option&&(d.selected=editItemVal));"function"==typeof b.callback&&b.callback(i,d)}$("div.opt").removeClass("tc")}else $("div.opt").html(f.message||"暂无数据").addClass("tc")}}):"function"==typeof b.callback&&b.callback({},d);else for(var f=b.editItem,g=0,h=f.length;h>g;g++)1==f[g].type&&f[g].options.length<1&&b.callback&&"function"==typeof b.callback&&b.callback({},d)}function l(a){if(a){a.obj&&!a.obj.facilitatorID&&(a.obj.facilitatorID=b("facilitatorID")||1),a.obj&&!a.obj.companyUserID&&(a.obj.companyUserID=b("companyUserID")||1);var c=a.type||"GET",d=t.URL;a.url&&$.ajax({url:d+a.url,type:c,data:a.obj,dataType:"jsonp",success:function(b){1==b.code||1==b.ret?a.callback(b):$("div.dialog").dialog({title:"提示",content:b.message||"请求数据失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},error:function(){$("div.dialog").dialog({title:"提示",content:json.message||"请求数据失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})}}function m(){var a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c).attr("data-id",$(this).attr("data-id")),b.hide()});var c=$("span","div.tabs"),d=$("div.item","div.tabcon");c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this),b=$("div.reg");b.removeClass("on"),"person"==a.attr("data-type")?b.eq(0).addClass("on"):b.eq(1).addClass("on")}),$("div.dialog,div.winpop").on("click","a.close",function(){$("div.dialog,div.winpop,div.mask").hide()}).on("click","a.btn-cancel",function(){$("div.dialog,div.winpop,div.mask").hide()})}function n(a,b,c){$("div.search").on("click","a.btn-search",function(a,b,c){l({url:a,obj:b,callback:c})})}function o(a){var b=[],c=[],d=[],e=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>",'<th width="40">序号</th>','<th ms-repeat="th" ms-attr-width="el.width">{{el.name}}</th>','<th ms-if-loop="isOpt" width="100">操作</th>',"</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="30" style="height:150px;padding-top:50px;text-align:center" ms-html="nodata"></td>',"</tr>",'<tr ms-repeat="tr">','<td ms-if-loop="isCheck" align="center"><input type="checkbox" ms-attr-value="el.id" ms-attr-id="el.id" /></td>','<td ms-if-loop="!isCheck" align="center">{{$index+1}}</td>','<td ms-repeat="th" ms-data-id="$index==0?getId($index):0" ms-attr-id="el.id"  ms-html="getkey($outer.$index,el.id,el.options)"></td>','<td align="center" ms-if-loop="isOpt"><a class="edit-item" ms-href="getId($index)" ms-attr-id="el.id" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),e.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >','<label><span class="fred"  ms-if-loop="el.ismust">* </span>{{el.name}}：</label> ','<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-attr-readonly="el.click" ms-attr-id="el.id" ms-data-id="el.id" ms-attr-value="el.value" ms-on-input="change" ms-blur="blur($index, $event)" ms-click="dialogData($index)"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-id="el.name" ms-attr-value="el.value">','<select class="select" ms-duplex="el.selected" ms-data-id="el.id" ms-attr-id="el.id"  ms-change="change">','<option ms-repeat="el.options" ms-attr-value="el.value" >{{el.text}}</option>',"</select>","</span>",'<span ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-data-id="el.id" ms-attr-value="el.value" class="remark"></textarea></span>','<span ms-if="el.type == 3"><label class="radiolabel" ms-repeat="el.options"><input type="radio" ms-attr-checked="el.value" ms-attr-name="$outer.el.id" /> {{el.text}}</label></span>','<span ms-if="el.type == 4"><label class="radiolabel" ms-repeat="el.options"><input type="checkbox" ms-attr-checked="el.value" ms-attr-name="$outer.el.id" /> {{el.text}}</label></span>',"</div>","</script>"].join("")),e.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),e.append(d))}function p(a){var b=null;l({url:"progressionBar.do",obj:{mainId:c("id")},callback:function(a){if(1==a.code){var c=a.data||{};if($("p",B).removeClass("on over"),!a.data)return;$("div.tire").css("left",parseInt(66*c.processNum+35)+"px");for(var d=1,e=$("p",B).length;e>d;d++){if(b=$("p.step"+d,B),c.processNum==b.attr("data-id"))return void b.addClass("on");b.addClass("over")}}}})}function q(a){var b={mainId:c("id"),processNum:a};COMMON.ajaxFn({url:"progressionBarSaveOrUpdate.do",obj:b,callback:function(b){var c="";c=1==b.code?"修改成功":"修改失败",y.dialog({title:"确认提示",content:c,button:[{text:"确认",cls:"btn-ok",handler:function(){y.dialog("hide")}}],callback:function(b){if("修改成功"==c){$("p",B).removeClass("on over");for(var d=0,e=$("p",B).length;e>d;d++)a>d&&$("p.step"+d,B).addClass("over");$("p.step"+a,B).addClass("on")}setTimeout(function(){b.dialog("hide")},2e3)}})}})}var r=Object.prototype.toString,s={MONTH:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],WEEK:["星期一.","星期二","星期三","星期四","星期五","星期六","星期日"]},t={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","正修","已修","内部交车","结算","交车"],CLASS:["保养","维修","美容"]},u={statusOpt:[{text:"全部",value:"0"},{text:"预约",value:"1"},{text:"未修",value:"2"},{text:"在修",value:"3"},{text:"已修",value:"4"},{text:"内部交车",value:"5"},{text:"结算",value:"6"},{text:"交车",value:"7"}],classOpt:[{text:"保养",value:"保养"},{text:"维修",value:"维修"},{text:"美容",value:"美容"}],oilOpt:[{text:"0",value:"0"},{text:"5%",value:"5%"},{text:"10%",value:"10%"},{text:"15%",value:"15%"},{text:"20%",value:"20%"},{text:"25%",value:"25%"},{text:"50%",value:"50%"},{text:"55%",value:"55%"},{text:"60%",value:"60%"},{text:"65%",value:"65%"},{text:"70%",value:"70%"},{text:"75%",value:"75%"},{text:"80%",value:"80%"},{text:"85%",value:"85%"},{text:"90%",value:"90%"},{text:"95%",value:"95%"},{text:"100%",value:"100%"}],colorOpt:[{text:"黑",value:"0"},{text:"白",value:"1"},{text:"红",value:"2"},{text:"黄",value:"3"},{text:"蓝",value:"4"},{text:"绿",value:"5"},{text:"银",value:"6"},{text:"橙",value:"7"}]},v={name:/^([A-Za-z0-9]|[\u4E00-\u9FA5]){2,16}$/i,tel:/^([0-9]{3,4}-)?[0-9]{7,8}$/,phone:/^1[3458]\d{9}$/,mail:/^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/i,qq:/^[1-9]\d{4,12}$/,num:/^[0-9]+.?[0-9]*$/,plate:/^[\u4E00-\u9FA5][\da-zA-Z]{6}$/,idcard:/^(^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$)|(^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])((\d{4})|\d{3}[Xx])$)$/},w={facilitatorID:b("facilitatorID")||1,companyUserID:b("companyUserID")||1},x=document.location.href,y=$("div.dialog"),z=$("div.mask"),A={series:e,brand:f,provider:g,teams:d},B=$("div.process");return B.on("click","p",function(){var a=$(this),b=a.index()+1,c=$("div.dialog");c.dialog({title:"确认修改流程",content:"确定要修改到当前状态吗？",button:[{text:"确定",cls:"btn-ok",handler:function(a){var b=a.attr("data-id");q(b)}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(){var a=$("div.dialog");a.addClass("auto"),a.attr("data-id",b)}})}),{init:function(){m()},OBJ:t,OPT:u,table:j,edit:k,addTpl:o,ajaxFn:l,search:n,getQuery:c,gettype:r,getCookie:b,setCookie:a,getProcess:p,defaultParam:w,loadData:A}}();$(function(){COMMON.init()});