var COMMON=function(){function k(a,b){var c=30,d=new Date;d.setTime(d.getTime()+1e3*60*60*24*c),document.cookie=a+"="+escape(b)+";expires="+d.toGMTString()}function l(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function m(a){var b,c,d,e,f,g;if(-1===h.indexOf("?")||-1===h.indexOf(a+"="))return"";for(b=h.substring(h.indexOf("?")+1),-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#"))),c=b.split("&"),g=0;g<c.length;g++)if(d=c[g].indexOf("="),-1!==d&&(e=c[g].substring(0,d),f=c[g].substring(d+1),e===a))return f.replace(/\+/g," ");return""}function n(){var a=avalon.define("brand",function(a){a.tr=[],a.getCon=function(){o(a,"listBrandByPage.do"),$.extend({},f)},a.saveItem=function(){p("brand")}}),b=avalon.define("series",function(a){a.tr=[],a.getCon=function(){o(a,"listVehicleTypeByPage.do")},a.saveItem=function(){p("series")}}),c=avalon.define("fuwushang",function(a){a.tr=[],a.getCon=function(){o(a,"facilitatorList.do")},a.saveItem=function(){p("facilitatorList")}});a.getCon(),b.getCon(),c.getCon()}function o(a,b){var c=$.extend({},f);s({url:b,obj:c,callback:function(c){if(1==c.code){var d=c.data||{};a.tr="facilitatorList.do"==b?d:d.data||{}}}})}function p(a){var g,h,c=[],d=[],e=$("input:checked",$("div."+a)),f=$("div.winpop");if("radio"==e.attr("type"))$("#"+a).val(e.val()).attr("data-value",e.attr("data-value"));else{for(g=0,h=e.length;h>g;g++)c.push(e.eq(g).val()),d.push(e.eq(g).attr("data-value"));$("#"+a).val(c.join(";")).attr("data-value",d)}f.hide(),j.hide()}function q(b){var d=function(){function j(b,c,d){c=$.extend({},f,c||{}),curpage=c.pageNum,c.pageSize=10,s({url:b,obj:c,callback:function(e){var f,i,j,n,l,m,o,p;if(1==e.code||1==e.ret){if(f=e.data||{},i=null,j=$("tr.loading",$("div[avalonctrl="+g.$id+"]")),"[object Array]"==a.call(f)){if(!(f.length>0))return g.nodata="暂无数据",j.show(),void 0;i=f}else if("[object Object]"==a.call(f)){if(!e.data)return g.nodata="暂无数据",j.show(),void 0;if(!e.data.data)return g.nodata="暂无数据",j.show(),void 0;i=f.data||{}}if(j.hide(),h.indexOf("yuyuejiedai")>-1)for(l=0,m=i.length;m>l;l++)n=i[l],n.maintainform&&(i[l]=$.extend({},n.maintainform||{},n));g.tr=[],g.tr=i||{},"function"==typeof d&&d(g),pageTotal=e.data["total"]||"",pageTotal&&1!=pageTotal?($("div.page").show(),o=pageTotal,p=$("div.page"),p.pager({pageNumber:curpage,pageTotal:o,change:function(a){c.pageNum=a,k(b,c,function(){g.getNum(a)})}})):$("div.page").hide()}}})}function k(a,b,c){j(a,b,c)}var c=b.id||"table",d=b.param,e=b.id||"model",g=avalon.define(e,function(a){a.$id=c,a.itemId=b.itemId,a.th=b.th,a.tr=[],a.isOpt=b.isOpt===!1?!1:!0,a.isCheck=b.isCheck===!0?!0:!1,a.nodata='<img src="img/loading.gif"/>',a.pageClass=b.pageClass||"pager",a.getkey=function(c,d){if(h.indexOf("index.html")>-1&&"state"==d)return'<img src="img/status'+a.tr[c][d]+'.png" />';if(a.tr.size()>0&&a.tr[c]){if(b.th[c]&&b.th[c].time){var e=a.tr[c][d];return new Date(e).toLocaleDateString()}return a.tr[c][d]}},a.getId=function(d){var g,i,j,f=a;return f.tr.length>0&&f.tr[d]&&1!=b.btntype?(g=h.split("/"),i=g[g.length-1].split(".html")[0]||"index",h.indexOf("caiwuguanli.html")>-1?(j=0,j="tablesingle"==c?0:1,i+"-opt.html?id="+f.tr[d][f.itemId]+"&type="+j):i+"-opt.html?id="+f.tr[d][f.itemId]):void 0},a.getNum=function(a){var d,e,b=$("tr",$("table.Mtable")),c=null;for(d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},a.delItem=function(c){var e=a.tr[c][b.itemId],g={};i.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(c){g[b.itemId]=e,g=$.extend({},f,g),s({url:b.delport,obj:g,callback:function(e){1==e.code&&(c.dialog("hide"),a.getTr(b.port,d,b.callback))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},a.addItem=function(){if(1==b.btntype)$("div.dialog").dialog("show"),"function"==typeof b.callback&&b.callback();else{var a=h.split("/"),c=a[a.length-1].split(".html")[0]||"index";h.indexOf("weixiujiedai")>-1?s({url:b.addport,obj:{},callback:function(a){1==a.code&&(location.href=c+"-opt.html?id="+a.data.mainId)}}):location.href=c+"-opt.html"}},a.getTr=function(){j(b.port,d,b.callback)},a.searchItem=function(){var c=$("div.search");d[$("span.select",c).attr("data-id")]=$("input.inpt-search",c).val(),a.getTr(b.port,d,b.callback)},a.saveItem=function(){"function"==typeof b.callback&&b.callback(a)}});avalon.scan()};d()}function r(a,c){var g,i,j,k,l;if(a=a||"edit",g=null,i={},j={status:0},(h.indexOf("xitongguanli")>-1||h.indexOf("caiwuguanli")>-1)&&(j={}),j[c.itemId]=m("id"),$("a.btn-return").on("click",function(){var a=m("type"),b="";a&&(b="?type="+a),location.href=h.substr(0,h.lastIndexOf("-opt"))+".html"+b}),g=avalon.define({$id:a,item:c.editItem,newData:i,isJump:!1,getNewData:function(){var h,f,g,d=c.editItem,e="";for(f=0,g=d.length;g>f;f++)h=d[f],e=i[h.id],h.selected||0==h.selected?e=e?e:h.selected:"time"==h.dataType?$("#"+h.id).datetimepicker({lang:"zh",i18n:{de:{months:b.MONTH,dayOfWeek:b.WEEK}},format:"Y/m/d",value:e?new Date(e).toLocaleDateString():(new Date).toLocaleDateString(),closeOnDateSelect:!0,onShow:function(){},timepicker:!1}):e=e?e:h.value},change:function(a){a.target.getAttribute("data-id")==c.itemId?i["mainId"]=a.target.value:i[a.target.getAttribute("data-id")]=a.target.value},flag:!0,blur:function(a,b){var d=g,f=c.editItem,h=b.target.value,i=$(b.target),j=i.parent(),k=f[a].dataType,m="";if(k)if("name"==k?e["name"].test(h)||(m="请输入真实姓名",d.flag=!1):"phone"==k?e["phone"].test(h)||(m="请输入正确的手机格式",d.flag=!1):"email"==k?e["email"].test(h)||(m="请输入正确的邮箱格式",d.flag=!1):"number"==k?e["num"].test(h)||(m="请输入数字格式",d.flag=!1):"plate"==k&&(e["plate"].test(h)||(m="请输入正确的车牌号",d.flag=!1)),m){if($("div.error",j).size()>0)return $("div.error",j).show(),void 0;j.append('<div class="error">'+m+"</div>")}else $("div.error",j).hide(),d.flag=!0},data:[],dialogData:function(a){c.editItem[a].click&&c.editItem[a].click(c.editItem[a].id,g)},addItem:function(){var b,d,a=c.addurl||c.addport;if(a)s({url:a,obj:f,callback:function(a){var b,d,e,f;if(1==a.code){for(b=c.itemId,d=a.data||{},i={},i[b]=d[b]||"&nbsp;",e=0,f=c.editItem.length;f>e;e++)c.editItem[e]["value"]="";c.editItem[b]=d[b],g.item=c.editItem}}});else for(b=0,d=c.editItem.length;d>b;b++)c.editItem[b].value="",i[c.editItem[b].name]=""},saveItem:function(){var a,b,d,e;if(g.flag){for(g.modifyId(),a=c.editItem,h.indexOf("kehuguanli-opt")>-1&&(b={},b.id=m("id"),b.carOwner=i.carOwner,b.carNum=i.carNum,b.carType=i.carType,i=b),m("id")&&(i[c.itemId]=m("id")),h.indexOf("yuyuejiedai-opt")>-1&&(i.mainId=m("id"),delete i[c.itemId]),d=0,e=a.length;e>d;d++)if(!i[a[d].value]){if(c.id&&c.itemId==a[d].id)continue;i[a[d].id]=$("#"+a[d].id).val()}h.indexOf("gerenyuyue")>-1&&(i.status=0),s({url:c.saveurl||c.saveport,type:"POST",obj:i,callback:function(a){1==a.code?$("div.dialog").dialog({title:"提示",content:a.message||"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide"),location.href=h.indexOf("gerenyuyue")>-1?h:m("type")?(h.substring(0,h.indexOf("-opt"))||"index")+".html?type="+m("type"):(h.substring(0,h.indexOf("-opt"))||"index")+".html"}}],callback:function(a){a.addClass("w400")}}):$("div.dialog").dialog({title:"提示",content:a.message||"保存失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})}},cancelItem:function(){for(k in i)"maintainfortNum"==k&&(i["mainId"]=i[k],delete i[k]);s({url:c.cancelport,type:"POST",obj:i,callback:function(a){1==a.code?location.href=(h.substring(0,h.indexOf("-opt"))||"index")+".html":alert("取消失败")}})},modifyId:function(){(h.indexOf("index")>-1||h.indexOf("weixiujiedai")>-1)&&i.maintainfortNum&&(i.mainId=i.maintainfortNum),h.indexOf("chejianguanli")>-1&&i.appointmentNum&&(i.maintainID=i.appointmentNum)}}),m("id"))c.id&&(j[c.id]=m("id")),h.indexOf("kufangguanli")>-1&&(j=$.extend({},{pageNumber:1,pageSize:10},j)),s({url:c.editurl||c.editport,obj:j,callback:function(b){var d,e,f,j,k,l,n;if(1==b.code){if(d=c.editItem,e="",f=b.data||{},!b.data)return $("div.opt[avalonctrl="+a+"]").html("暂无数据").addClass("tc"),void 0;if(c.edittype&&(f=f.length>0?f[0]||{}:f.data[0]||{}),h.indexOf("yuyuejiedai")>-1&&(f=$.extend({},f.maintainform||{},f)),f){for(j=g.item,k=null,l=0,n=d.length;n>l;l++)k=j[l],e=d[l]["id"],(h.indexOf("index")>-1||h.indexOf("weixiujiedai")>-1)&&"maintainfortNum"==e?(editItemVal=m("id"),k.value=editItemVal,i["mainId"]=editItemVal):(editItemVal=f[e],k.value=editItemVal,i[e]=editItemVal,d[l]["option"]&&(g.selected=editItemVal));"function"==typeof c.callback&&c.callback(f,g)}$("div.opt").removeClass("tc")}else $("div.opt").html(b.message||"暂无数据").addClass("tc")}});else for(j=c.editItem,k=0,l=j.length;l>k;k++)1==j[k].type&&j[k].options.length<1&&c.callback&&"function"==typeof c.callback&&c.callback({},g)}function s(a){if(a){a.obj&&!a.obj.facilitatorID&&(a.obj.facilitatorID=l("facilitatorID")||1),a.obj&&!a.obj.companyUserID&&(a.obj.companyUserID=l("companyUserID")||1);var b=a.type||"GET",d=c.URL;a.url&&$.ajax({url:d+a.url,type:b,data:a.obj,dataType:"jsonp",success:function(b){1==b.code||1==b.ret?a.callback(b):$("div.dialog").dialog({title:"提示",content:b.message||"请求数据失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},error:function(){$("div.dialog").dialog({title:"提示",content:json.message||"请求数据失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})}}function t(){var c,d,a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c).attr("data-id",$(this).attr("data-id")),b.hide()}),c=$("span","div.tabs"),d=$("div.item","div.tabcon"),c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this),b=$("div.reg");b.removeClass("on"),"person"==a.attr("data-type")?b.eq(0).addClass("on"):b.eq(1).addClass("on")}),$("div.dialog,div.winpop").on("click","a.close",function(){$("div.dialog,div.winpop,div.mask").hide()}).on("click","a.btn-cancel",function(){$("div.dialog,div.winpop,div.mask").hide()})}function u(){$("div.search").on("click","a.btn-search",function(a,b,c){s({url:a,obj:b,callback:c})})}function v(a){var b=[],c=[],d=[],f=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>",'<th width="40">序号</th>','<th ms-repeat="th" ms-attr-width="el.width">{{el.name}}</th>','<th ms-if-loop="isOpt" width="100">操作</th>',"</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="30" style="height:150px;padding-top:50px;text-align:center" ms-html="nodata"></td>',"</tr>",'<tr ms-repeat="tr">','<td ms-if-loop="isCheck" align="center"><input type="checkbox" ms-attr-value="el.id" ms-attr-id="el.id" /></td>','<td ms-if-loop="!isCheck" align="center">{{$index+1}}</td>','<td ms-repeat="th" ms-data-id="$index==0?getId($index):0" ms-attr-id="el.id"  ms-html="getkey($outer.$index,el.id)"></td>','<td align="center" ms-if-loop="isOpt"><a class="edit-item" ms-href="getId($index)" ms-attr-id="el.id" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),f.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >','<label><span class="fred"  ms-if-loop="el.ismust">* </span>{{el.name}}：</label> ','<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-attr-readonly="el.click" ms-attr-id="el.id" ms-data-id="el.id" ms-attr-value="el.value" ms-on-input="change" ms-blur="blur($index, $event)" ms-click="dialogData($index)"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-id="el.name" ms-attr-value="el.value">','<select class="select" ms-duplex="el.selected" ms-data-id="el.id" ms-attr-id="el.id"  ms-change="change">','<option ms-repeat="el.options" ms-attr-value="el.value" >{{el.text}}</option>',"</select>","</span>",'<span ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-data-id="el.id" ms-attr-value="el.value" class="remark"></textarea></div>',"</span>","</script>"].join("")),f.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),f.append(d))}function x(){var b=null;s({url:"progressionBar.do",obj:{mainId:m("id")},callback:function(a){var c,d,e;if(1==a.code){if(c=a.data||{},$("p",w).removeClass("on over"),!a.data)return;for(d=1,e=$("p",w).length;e>d;d++){if(b=$("p.step"+d,w),c.processNum==b.attr("data-id"))return b.addClass("on"),void 0;b.addClass("over")}}}})}function y(a){var b={mainId:m("id"),processNum:a};COMMON.ajaxFn({url:"progressionBarSaveOrUpdate.do",obj:b,callback:function(b){var c="";c=1==b.code?"修改成功":"修改失败",i.dialog({title:"确认提示",content:c,button:[{text:"确认",cls:"btn-ok",handler:function(){i.dialog("hide")}}],callback:function(b){if("修改成功"==c){$("p",w).removeClass("on over");for(var d=0,e=$("p",w).length;e>d;d++)a>d&&$("p.step"+d,w).addClass("over");$("p.step"+a,w).addClass("on")}setTimeout(function(){b.dialog("hide")},2e3)}})}})}var a=Object.prototype.toString,b={MONTH:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],WEEK:["星期一.","星期二","星期三","星期四","星期五","星期六","星期日"]},c={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","正修","已修","内部交车","结算","交车"],CLASS:["保养","维修","美容"]},d={statusOpt:[{text:"全部",value:"0"},{text:"预约",value:"1"},{text:"未修",value:"2"},{text:"在修",value:"3"},{text:"已修",value:"4"},{text:"内部交车",value:"5"},{text:"结算",value:"6"},{text:"交车",value:"7"}],classOpt:[{text:"保养",value:"保养"},{text:"维修",value:"维修"},{text:"美容",value:"美容"}],oilOpt:[{text:"半满",value:"0"},{text:"满",value:"1"}],colorOpt:[{text:"黑",value:"0"},{text:"白",value:"1"},{text:"红",value:"2"},{text:"黄",value:"3"},{text:"蓝",value:"4"},{text:"绿",value:"5"},{text:"银",value:"6"},{text:"橙",value:"7"}]},e={name:/^([A-Za-z0-9]|[\u4E00-\u9FA5]){2,16}$/i,phone:/^1[3458]\d{9}$/,mail:/^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/i,qq:/^[1-9]\d{4,12}$/,num:/^[0-9]+.?[0-9]*$/,plate:/^[\u4E00-\u9FA5][\da-zA-Z]{6}$/},f={facilitatorID:l("facilitatorID")||1,companyUserID:l("companyUserID")||1},h=document.location.href,i=$("div.dialog"),j=$("div.mask"),w=$("div.process");return w.on("click","p",function(){var a=$(this),b=a.index()+1,c=$("div.dialog");c.dialog({title:"确认修改流程",content:"确定要修改到当前状态吗？",button:[{text:"确定",cls:"btn-ok",handler:function(a){var b=a.attr("data-id");y(b)}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(){var a=$("div.dialog");a.addClass("auto"),a.attr("data-id",b)}})}),{init:function(){n(),t()},OBJ:c,OPT:d,table:q,edit:r,addTpl:v,ajaxFn:s,search:u,getQuery:m,gettype:a,getCookie:l,setCookie:k,getProcess:x,defaultParam:f}}();$(function(){COMMON.init()});