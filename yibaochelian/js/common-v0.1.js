var COMMON=function(){function g(a,b){var c=30,d=new Date;d.setTime(d.getTime()+1e3*60*60*24*c),document.cookie=a+"="+escape(b)+";expires="+d.toGMTString()}function h(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function j(a){var b,c,d,f,g,h;if(-1===e.indexOf("?")||-1===e.indexOf(a+"="))return"";for(b=e.substring(e.indexOf("?")+1),-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#"))),c=b.split("&"),h=0;h<c.length;h++)if(d=c[h].indexOf("="),-1!==d&&(f=c[h].substring(0,d),g=c[h].substring(d+1),f===a))return g.replace(/\+/g," ");return""}function k(){var b,c,a=["index","yuyuejiedai","weixiujiedai","weixiulingliao","chejianguanli","kufangguanli","kehuguanli","yonghuguanli","caiwuguanli","xitongguanli"];for(b=0,c=a.length;c>b;b++)e.indexOf(a[b])>0&&$("a","div.mainnav").removeClass("on").eq(b).addClass("on")}function l(b){var g=function(){function j(b,d,f){d=$.extend({},c,d||{}),curpage=d.pageNum,d.pageSize=10,n({url:b,obj:d,callback:function(c){var g,h,j,n,l,m,o;if(1==c.code||1==c.ret){if(g=c.data||{},h=null,j=$("tr.loading",$("div[avalonctrl="+i.$id+"]")),"[object Array]"==a.call(g)){if(!(g.length>0))return i.nodata="暂无数据",j.show(),void 0;h=g}else if("[object Object]"==a.call(g)){if(!c.data)return i.nodata="暂无数据",j.show(),void 0;if(!c.data.data)return i.nodata="暂无数据",j.show(),void 0;h=g.data||{}}if(j.hide(),e.indexOf("yuyuejiedai")>-1)for(l=0,m=h.length;m>l;l++)n=h[l],n.maintainform&&(h[l]=$.extend({},n.maintainform||{},n));i.tr=[],i.tr=h||{},"function"==typeof f&&f(i),pageTotal=c.data["total"]||"",pageTotal&&(o=pageTotal,$("div.page").pager({pageNumber:curpage,pageTotal:o,change:function(a){d.pageNum=a,k(b,d,function(){i.getNum(a)})}}))}}})}function k(a,b,c){j(a,b,c)}var d=b.id||"table",g=b.param,h=b.id||"model",i=avalon.define(h,function(a){a.$id=d,a.itemId=b.itemId,a.th=b.th,a.tr=[],a.isOpt=b.isOpt===!1?!1:!0,a.nodata='<img src="img/loading.gif"/>',a.getkey=function(c,d){if(e.indexOf("index.html")>-1&&"state"==d)return'<img src="img/status'+a.tr[c][d]+'.png" />';if(a.tr.size()>0&&a.tr[c]){if(b.th[c]&&b.th[c].time){var f=a.tr[c][d];return new Date(f).toLocaleDateString()}return a.tr[c][d]}},a.getId=function(c){var g,h,i,f=a;return f.tr.size()>0&&f.tr[c]&&1!=b.btntype?(g=e.split("/"),h=g[g.length-1].split(".html")[0]||"index",e.indexOf("caiwuguanli")>-1?(i="",i="应收账单"==$("span.on","div.tabs").html()?0:1,h+"-opt.html?id="+f.tr[c][f.itemId]+"&type="+i):h+"-opt.html?id="+f.tr[c][f.itemId]):void 0},a.getNum=function(a){var d,e,b=$("tr",$("table.Mtable")),c=null;for(d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},a.delItem=function(d){var e=a.tr[d][b.itemId],h={};f.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(d){h[b.itemId]=e,h=$.extend({},c,h),n({url:b.delport,obj:h,callback:function(c){1==c.code&&(d.dialog("hide"),a.getTr(b.port,g,b.callback))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},a.addItem=function(){if(1==b.btntype)$("div.dialog").dialog("show"),"function"==typeof b.callback&&b.callback();else{var a=e.split("/"),c=a[a.length-1].split(".html")[0]||"index";e.indexOf("weixiujiedai")>-1?n({url:b.addport,obj:{},callback:function(a){1==a.code&&(location.href=c+"-opt.html?id="+a.data.mainId)}}):location.href=c+"-opt.html"}},a.getTr=function(){j(b.port,g,b.callback)},a.searchItem=function(){var c=$("div.search");g[$("span.select",c).attr("data-id")]=$("input.inpt-search",c).val(),a.getTr(b.port,g,b.callback)}});avalon.scan()};g()}function m(a,b){var a=a||"edit",d=null,f={},g={status:0};(e.indexOf("xitongguanli")>-1||e.indexOf("caiwuguanli")>-1)&&(g={}),g[b.itemId]=j("id"),j("id")&&(b.id&&(g[b.id]=j("id")),e.indexOf("kufangguanli")>-1&&(g=$.extend({},{pageNumber:1,pageSize:10},g)),n({url:b.editurl||b.editport,obj:g,callback:function(a){var c,g,h,i,k;if(1==a.code){if(c=b.editItem,g="",h=a.data||{},b.edittype&&(h=h.length>0?h[0]||{}:h.data[0]||{}),e.indexOf("yuyuejiedai")>-1&&(h=$.extend({},h.maintainform||{},h)),h){for(i=0,k=c.length;k>i;i++)g=c[i]["id"],(e.indexOf("index")>-1||e.indexOf("weixiujiedai")>-1)&&"maintainfortNum"==g?(editItemVal=j("id"),d.item[i].value=editItemVal,f["mainId"]=editItemVal):(editItemVal=h[g],d.item[i].value=editItemVal,f[g]=editItemVal,c[i]["option"]&&(d.selected=editItemVal));"function"==typeof b.callback&&b.callback(h,d)}}else $("div.opt").html(a.message||"数据不存在")}})),d=avalon.define({$id:a,item:b.editItem,newData:f,change:function(a){a.target.getAttribute("data-id")==b.itemId?f["mainId"]=a.target.value:f[a.target.getAttribute("data-id")]=a.target.value},data:[],dialogData:function(a,b){b&&(obj=$.extend({},c,b.param||{}),n({url:b.url,obj:obj,callback:function(b){var c,d,e,g,h;if(1==b.code&&(c=[],b.data)){for(d=b.data.data||{},e="",g=0,h=d.length;h>g;g++)e=d[g][a],c.push(['<span class="label">','<input type="radio" value="'+e+'" />'+e,"</span>"].join(""));$("div.dialog").dialog({title:"修改窗口",content:c.join(""),button:[{text:"确定",cls:"btn-ok",handler:function(b){$(".bd input",b),$("input[data-id="+a+"]").val($("input:checked",b).val()),f[a]=$("input:checked",b).val(),b.dialog("hide")}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("dialog-select")}})}}}))},addItem:function(){var e,g,a=b.addurl||b.addport;if(a)n({url:a,obj:c,callback:function(a){var c,e,g,h;if(1==a.code){for(c=b.itemId,e=a.data||{},f={},f[c]=e[c]||"&nbsp;",g=0,h=b.editItem.length;h>g;g++)b.editItem[g]["value"]="";b.editItem[c]=e[c],d.item=b.editItem}}});else for(e=0,g=b.editItem.length;g>e;e++)b.editItem[e].value="",f[b.editItem[e].name]=""},saveItem:function(){if(d.modifyId(),e.indexOf("kehuguanli-opt")>-1){var a={};a.id=j("id"),a.carOwner=f.carOwner,a.carNum=f.carNum,a.carType=f.carType,f=a}f[b.itemId]=j("id"),n({url:b.saveurl||b.saveport,type:"POST",obj:f,callback:function(a){1==a.code?$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide"),location.href=j("type")?(e.substring(0,e.indexOf("-opt"))||"index")+".html?type="+j("type"):(e.substring(0,e.indexOf("-opt"))||"index")+".html"}}],callback:function(a){a.addClass("w400")}}):$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})},cancelItem:function(){for(i in f)"maintainfortNum"==i&&(f["mainId"]=f[i],delete f[i]);n({url:b.cancelport,type:"POST",obj:f,callback:function(a){1==a.code?location.href=(e.substring(0,e.indexOf("-opt"))||"index")+".html":alert("取消失败")}})},modifyId:function(){(e.indexOf("index")>-1||e.indexOf("weixiujiedai")>-1)&&f.maintainfortNum&&(f.mainId=f.maintainfortNum),e.indexOf("chejianguanli")>-1&&f.appointmentNum&&(f.maintainID=f.appointmentNum)}})}function n(a){if(a){a.obj&&!a.obj.facilitatorID&&(a.obj.facilitatorID=h("facilitatorID")||1),a.obj&&!a.obj.companyUserID&&(a.obj.companyUserID=h("companyUserID")||1);var c=a.type||"GET",d=b.URL;a.url&&(a.url&&a.url.indexOf("role")>-1&&(d=d.replace("enterprise/","")),$.ajax({url:d+a.url,type:c,data:a.obj,dataType:"jsonp",success:function(b){1==b.code||1==b.ret?a.callback(b):$(".loading").html("暂无数据")},error:function(){$(".loading").html("暂无数据")}}))}}function o(){var c,d,a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c).attr("data-id",$(this).attr("data-id")),b.hide()}),c=$("span","div.tabs"),d=$("div.item","div.tabcon"),c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this),b=$("div.reg");b.removeClass("on"),"person"==a.attr("data-type")?b.eq(0).addClass("on"):b.eq(1).addClass("on")}),$("div.dialog,div.winpop").on("click","a.close",function(){$("div.dialog,div.winpop").hide()}).on("click","a.btn-cancel",function(){$("div.dialog,div.winpop").hide()})}function p(){$("div.search").on("click","a.btn-search",function(a,b,c){n({url:a,obj:b,callback:c})})}function q(a){var b=[],c=[],d=[],f=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>",'<th width="40">序号</th>','<th ms-repeat="th" ms-attr-width="el.width">{{el.name}}</th>','<th ms-if-loop="isOpt" width="100">操作</th>',"</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="30" style="height:150px;padding-top:50px;text-align:center" ms-html="nodata"></td>',"</tr>",'<tr ms-repeat="tr">','<td align="center">{{$index+1}}</td>','<td ms-repeat="th" ms-data-id="$index==0?getId($index):0"  ms-html="getkey($outer.$index,el.id)"></td>','<td align="center" ms-if-loop="isOpt"><a class="edit-item" ms-href="getId($index)" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),f.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >','<label><span class="fred"  ms-if-loop="el.ismust">* </span>{{el.name}}：</label> ','<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-data-id="el.id" ms-attr-data-id="el.id" ms-attr-value="el.value" ms-on-input="change" ms-click="dialogData(el.id,el.click)"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-id="el.name" ms-attr-value="el.value">','<select class="select" ms-duplex="el.selected" ms-attr-id="el.id">','<option ms-repeat="el.options" ms-attr-value="el.value" >{{el.text}}</option>',"</select>","</span>",'<span ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-data-id="el.id" ms-attr-value="el.value" class="remark"></textarea></div>',"</span>","</script>"].join("")),f.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),f.append(d))}function s(){var b=null;n({url:"progressionBar.do",obj:{mainId:j("id")},callback:function(a){if(1==a.code){$("p",r).removeClass("on over");for(var c=1,d=$("p",r).length;d>c;c++){if(b=$("p.step"+c,r),a.data.processNum==b.attr("data-id"))return b.addClass("on"),void 0;b.addClass("over")}}}})}function t(a){var b={mainId:j("id"),processNum:a};COMMON.ajaxFn({url:"progressionBarSaveOrUpdate.do",obj:b,callback:function(b){var c="";c=1==b.code?"修改成功":"修改失败",f.dialog({title:"确认提示",content:c,button:[{text:"确认",cls:"btn-ok",handler:function(){f.dialog("hide")}}],callback:function(b){if("修改成功"==c){$("p",r).removeClass("on over");for(var d=0,e=$("p",r).length;e>d;d++)a>d&&$("p.step"+d,r).addClass("over");$("p.step"+a,r).addClass("on")}setTimeout(function(){b.dialog("hide")},2e3)}})}})}var a=Object.prototype.toString,b={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","正修","已修","内部交车","结算","交车"],CLASS:["保养","维修","美容"]},c={facilitatorID:h("facilitatorID")||1,companyUserID:h("companyUserID")||1},e=document.location.href,f=$("div.dialog"),r=$("div.process");return r.on("click","p",function(){var a=$(this),b=a.index()+1,c=$("div.dialog");c.dialog({title:"确认修改流程",content:"确定要修改到当前状态吗？",button:[{text:"确定",cls:"btn-ok",handler:function(a){var b=a.attr("data-id");t(b)}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(){var a=$("div.dialog");a.addClass("auto"),a.attr("data-id",b)}})}),{init:function(){k(),o()},OBJ:b,table:l,edit:m,addTpl:q,ajaxFn:n,search:p,getQuery:j,gettype:a,getCookie:h,setCookie:g,getProcess:s,defaultParam:c}}();$(function(){COMMON.init()});