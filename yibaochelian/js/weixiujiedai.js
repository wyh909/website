$(function(){function g(a){var c=$("div.winpop"),d=$("div.mask"),e=$("div.bd",c);"appointmentTime"==a||(c.show(),d.show(),e.hide(),$("div."+a,c).show())}function j(a,b){var b=$.extend({},{mainId:COMMON.getQuery("id")},b||{}),c=e[a];f.th=c.thadd,f.tr=[],b=b||{},COMMON.ajaxFn({url:c.addport,obj:b,callback:function(b){var c=b.data||{},d=c.data||{},e=$("tr.loading",$("div[avalonctrl=table_list]"));d&&d.length>0?(f.tr=d,1==a&&$(".Mtable","div.addyyxm").css("width","1200px"),e.hide()):(f.nodata="暂无数据",e.show())}})}function k(){$("div.yuyue").on("click",".tabitem a.edit-item",function(){var a=$(this);a.parent().siblings(),l(a,child.curIndex,"serviceItemDoSave.do")})}function l(a,b,c){var d,e,f,g,h,i,j;if(c="",c=0==b?"serviceItemDoSave.do":"editUsedCompent.do",a.hasClass("save-item")){for(d=$("input",a.parent().siblings()),e=null,f={mainId:id},g=0,h=d.length;h>g;g++)e=d.eq(g),f[e.attr("data-id")]=e.val();COMMON.ajaxFn({url:c,obj:f,callback:function(a){1==a.code&&$("div.dialog").dialog({title:"窗口提示",content:"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){child.changeIndex(b),a.dialog("hide")}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})}else for(i="",j=a.parent().siblings(),a.html("保存").addClass("save-item"),g=0,h=j.length;h>g;g++)$cur=j.eq(g),1==b&&3==g&&(i=$cur.text(),$cur.html('<input style="width:80px" type="text" data-id="'+$cur.attr("id")+'" value="'+i+'"/>')),(4==g||5==g||6==g||7==g)&&(i=$cur.text(),$cur.html('<input style="width:80px" type="text" data-id="'+$cur.attr("id")+'" value="'+i+'"/>'))}var d,e,f,b=(window.location.href,document.location.href.indexOf("opt.html")>-1),c=COMMON.getQuery("operation");id=COMMON.getQuery("id"),defaultParam=COMMON.defaultParam,$winpop=$("div.winpop"),$mask=$("div.mask"),OPT=COMMON.OPT,colorOpt=OPT.colorOpt,oilOpt=OPT.oilOpt,classOpt=OPT.classOpt,statusOpt=OPT.statusOpt,th=[{id:"maintainfortNum",name:"维修单号"},{id:"truename",name:"姓名"},{id:"platenumber",name:"车牌号"},{id:"phone",name:"电话"},{id:"maintaintype",name:"类别"},{id:"status",name:"状态"}],tableObj={id:"table",port:"maintainformList.do",addport:"maintainformInput.do",delport:"maintainformDelete.do",itemId:"maintainfortNum",th:th,param:{pageNum:1},callback:function(a){for(var d,b=0,c=a.tr.length;c>b;b++)d=a.tr[b].status,a.tr[b].status=statusOpt[d].text}},thYuyue=[{id:"itemId",name:"推荐项目id",width:80},{id:"itemName",name:"推荐项目名称",width:""},{id:"workType",name:"工种",width:""},{id:"faultCode",name:"错误代码",width:""},{id:"standardWorkTime",name:"标准工时",width:""},{id:"standardUnitPrice",name:"标准单价",width:""},{id:"coastWorkTime",name:"工时花费"}],thLingliao=[{id:"productID",name:"商品编码"},{id:"productname",name:"商品名称"},{id:"unit",name:"单位"},{id:"productnum",name:"数量",isEdit:!0},{id:"unitprice",name:"单价",isEdit:!0},{id:"teams",name:"领料班组",isEdit:!0},{id:"maintenanceMan",name:"领料人",isEdit:!0}],thDanju=[{id:"maintainID",name:"预约单号"},{id:"checker",name:"检测人"},{id:"checkDate",name:"检测时间",dataType:"time"},{id:"Accounter",name:"结算人"},{id:"accountDate",name:"结算时间",dataType:"time"},{id:"checkout",name:"收银人"},{id:"checkoutDate",name:"收银时间",dataType:"time"},{id:"completionDate",name:"完工时间",dataType:"time"},{id:"Outmaker",name:"出厂时间",dataType:"time"},{id:"Header",name:"负责人"}],thFeiyong=[{id:"laborCost",name:"工时费"},{id:"materiaCost",name:"材料费"},{id:"otherCost",name:"其他费"},{id:"pageName",name:"套餐"},{id:"totalCost",name:"合计"}],thxmll=[{id:"productID",name:"商品编号"},{id:"productname",name:"商品名称"},{id:"origin",name:"产地"},{id:"type",name:"分类"},{id:"carModle",name:" 车型"},{id:"lastdeliveryDate",name:"最近出货时间"},{id:"lastpurchaseDate",name:" 最近进货时间"},{id:"account",name:"商品可售数量"},{id:"unit",name:"单位（升，个）"},{id:"safeaccount",name:"安全数量"},{id:"suggestBuyprice",name:"建议购买价格"},{id:"suggestSaleprice",name:" 建议销售价格"},{id:"repertory",name:"仓库名称"}],yuyuexiangmu={id:"childTable",port:"serviceItemList.do",addport:"serviceItemInput.do",saveport:"serviceItemDoSave.do",isOpt:!1,isCheck:!0,th:thYuyue,thadd:thYuyue,btntype:1,param:{pageNum:1}},xiangmulingliao={id:"childTable",port:"usedCompontList.do",addport:"usedCompontInput.do",saveport:"usedCompentDoSave.do",isOpt:!1,th:thLingliao,thadd:thxmll,param:{pageNum:1}},danjuxinxi={itemId:"mainId",isJump:!0,editport:"orderdetail.do",saveport:"orderdetail.do",editItem:[{id:"maintainID",name:"预约单号",value:""},{id:"checker",name:"检测人",value:""},{id:"checkDate",name:"检测时间",value:"",dataType:"time"},{id:"Accounter",name:"结算人",value:""},{id:"accountDate",name:"结算时间",value:"",dataType:"time"},{id:"checkout",name:"收银人",value:""},{id:"checkoutDate",name:"收银时间",value:"",dataType:"time"},{id:"completionDate",name:"完工时间",value:"",dataType:"time"},{id:"Outmaker",name:"出厂时间",value:"",dataType:"time"},{id:"Header",name:"负责人",value:""}],callback:function(a){a.status&&$("span.fred","div.opt-tit").html(statusOpt[a.status]["text"])}},feiyongheji={id:"childTable",port:"costsheet.do",th:thFeiyong,param:{pageNum:1}},editObj={itemId:"mainId",editport:"maintainformDetail.do",saveport:"maintainformSaveOrUpdate.do",editItem:[{id:"maintainfortNum",name:"维修单ID",value:""},{id:"truename",name:"姓名",value:""},{id:"phone",name:"手机",value:"",dataType:"phone"},{id:"qqid",name:"QQ",value:"",dataType:"qq"},{id:"custDept",name:"客户单位",value:""},{id:"address",name:"地址",value:""},{id:"brand",name:"品牌",value:"",click:g},{id:"series",name:"车系",value:"",click:g},{id:"platenumber",name:"车牌",value:"",dataType:"plate"},{id:"color",name:"颜色",type:1,selected:"0",options:colorOpt},{id:"motorNumber",name:"发动机码",value:""},{id:"motorNumber",name:"底盘号",value:""},{id:"miles",name:"公里数",value:"",dataType:"number"},{id:"oil",name:"油表状态",value:"",type:1,selected:"0",options:oilOpt},{id:"maintaintype",name:"维修类型",type:1,selected:"美容",options:classOpt},{id:"receiveCar",name:"接车员",value:""},{id:"arriveTime",name:"接车时间",value:"",dataType:"time"},{id:"exeptTime",name:"预计时间",value:"",dataType:"time"},{id:"status",name:"状态",type:1,selected:"0",options:statusOpt}],callback:function(a){a.status&&$("span.fred","div.opt-tit").html(statusOpt[a.status]["text"])}},b?(COMMON.addTpl({table:1,th:th}),COMMON.addTpl({edit:1}),"add"==c?COMMON.edit("edit",editObj):COMMON.edit("edit",editObj),avalon.scan(),d={port:"usedCompontInput.do",obj:COMMON.defaultParam,isFold:!1},TREE.tree($("div.tree"),d),e=[yuyuexiangmu,xiangmulingliao,danjuxinxi,feiyongheji],child=avalon.define("childTable",function(a){a.tab=["预约项目","项目领料","单据信息","费用合计","项目进度"],a.curIndex=0,a.th=[],a.tr=[],a.item=[],a.newData=[],a.isCheck=a["curIndex"].isCheck===!0?!0:!1,a.nodata='<img src="img/loading.gif"/>',a.isOpt=!0,a.changeIndex=function(b,c){if(a.curIndex=b,2!=b){var d=e[b],f={mainId:COMMON.getQuery("id")};a.th.removeAll(),a.th.pushArray(d.th),COMMON.ajaxFn({url:d.port,obj:f,callback:function(b){var e,f,g,h,i;if(1==b.code)if(e=null,a.tr=[],$loading=$("tr.loading"),b.data){if(e=b.data,3==a.curIndex&&e.recommendItem&&(e.pageName=e.recommendItem.pageName),e.length<1)$loading.show(),a.nodata="暂无数据";else{if(e.data?e=e.data||{}:($loading.show(),a.nodata="暂无数据"),e instanceof Array?a.tr=e||[]:(f=[],f.push(e),a.tr=f),0==a.curIndex)for(g=0,h=$("tr","table tbody").length;h>g;g++)$("tr","table tbody").eq(g).find("a").last().hide();$loading.hide()}i=b.data["total"]||"",i&&$("div.page").pager({pageNumber:c,pageTotal:i,change:function(b){d.pageNum=b,a.changeIndex(g)}})}else $loading.show(),a.nodata="暂无数据"}})}},a.getkey=function(a,b){var f,g,h,i,j,c=child;if(2!=c.curIndex&&c.tr.size()>0&&child.tr[a]){for(child.tr[a][b],f=e[c.curIndex].th,g=null,h=null,i=0,j=f.length;j>i;i++)if(h=f[i],h.id==b&&"time"==h.dataType)return g=c.tr[a][b]||new Date,new Date(g).toLocaleDateString();return c.tr[a][b]}},a.getId=function(a){var c=child;return c.tr.size()>0&&c.tr[a]?"javascript:;":void 0},a.addItem=function(){$("div.bd",$winpop).hide(),$("div.addyyxm",$winpop).show(),$winpop.dialog("show"),j(child.curIndex),$("#tree").on("click","a",function(){j(child.curIndex,{itemName:$(this).html()})})},a.delItem=function(b){var c=e[a.curIndex],d=a.tr[b][c.itemId],f={};$dialog.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(b){f[c.itemId]=d,f=$.extend({},defaultParam,f),COMMON.ajaxFn({url:c.delport,obj:f,callback:function(c){1==c.code&&(b.dialog("hide"),a.changeIndex(a.curIndex))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}}),f=avalon.define("table_list",function(a){a.th=[],a.tr=[],a.search={itemId:"",itemName:""},a.isOpt=!1,a.isCheck=!0,a.nodata='<img src="img/loading.gif"/>',a.getkey=function(a,b){var c=f;return c.tr.size()>0&&c.tr[a]?c.tr[a][b]:void 0},a.getId=function(a){var c=child;return c.tr.size()>0&&c.tr[a]?"javascript:;":void 0},a._thInit=function(){var b=this;return"width:"+b.th.width},a.saveItem=function(){var g,h,a=[],b=$("input:checkbox",$winpop),c=null,d=child.curIndex,f=e[d].saveport;for(g=0,h=b.length;h>g;g++)c=b.eq(g).parent().next("td").text(),b.eq(g).attr("checked")&&a.push(c);COMMON.ajaxFn({url:f,obj:{mainId:id,itemIds:a.join(";")},callback:function(){$winpop.dialog("hide"),child.changeIndex(d)}})},a.searchFn=function(){var a={itemId:$("#itemId").val()||"",itemName:$("#itemName").val()||""};j(child.curIndex,a)}}),avalon.scan(),child.changeIndex(0),COMMON.edit("dd",danjuxinxi),k()):(COMMON.addTpl({table:1,th:th}),COMMON.table(tableObj))});