$(function(){function a(a,b){var c=$("div.winpop"),d=$("div.mask"),e=$("div.bd",c);"appointmentTime"==a||(c.show(),d.show(),e.hide(),$("div."+a,c).show())}function b(a,b){var b=$.extend({},{mainId:COMMON.getQuery("id")},b||{}),c=h[a];i.th=c.thadd,i.tr=[],b=b||{},COMMON.ajaxFn({url:c.addport,obj:b,callback:function(b){var c=b.data||{},d=c.data||{},e=$("tr.loading",$("div[avalonctrl=table_list]"));d&&d.length>0?(i.tr=d,1==a&&$(".Mtable","div.addyyxm").css("width","1200px"),e.hide()):(i.nodata="暂无数据",e.show())}})}function c(){$("div.yuyue").on("click",".tabitem a.edit-item",function(){var a=$(this);a.parent().siblings();d(a,child.curIndex,"serviceItemDoSave.do")})}function d(a,b,c){var c="";if(c=0==b?"serviceItemDoSave.do":"editUsedCompent.do",a.hasClass("save-item")){for(var d=$("input",a.parent().siblings()),e=null,f={mainId:id},g=0,h=d.length;h>g;g++)e=d.eq(g),f[e.attr("data-id")]=e.val();COMMON.ajaxFn({url:c,obj:f,callback:function(a){1==a.code&&$("div.dialog").dialog({title:"窗口提示",content:"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){child.changeIndex(b),a.dialog("hide")}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})}else{var i="",j=a.parent().siblings();a.html("保存").addClass("save-item");for(var g=0,h=j.length;h>g;g++)$cur=j.eq(g),1==b&&3==g&&(i=$cur.text(),$cur.html('<input style="width:80px" type="text" data-id="'+$cur.attr("id")+'" value="'+i+'"/>')),(4==g||5==g||6==g||7==g)&&(i=$cur.text(),$cur.html('<input style="width:80px" type="text" data-id="'+$cur.attr("id")+'" value="'+i+'"/>'))}}var e=(window.location.href,document.location.href.indexOf("opt.html")>-1),f=COMMON.getQuery("operation");if(id=COMMON.getQuery("id"),defaultParam=COMMON.defaultParam,$winpop=$("div.winpop"),$mask=$("div.mask"),OPT=COMMON.OPT,colorOpt=OPT.colorOpt,oilOpt=OPT.oilOpt,classOpt=OPT.classOpt,statusOpt=OPT.statusOpt,th=[{id:"maintainfortNum",name:"维修单号"},{id:"truename",name:"姓名"},{id:"platenumber",name:"车牌号"},{id:"phone",name:"电话"},{id:"maintaintype",name:"类别"},{id:"status",name:"状态"}],tableObj={id:"table",port:"maintainformList.do",addport:"maintainformInput.do",delport:"maintainformDelete.do",itemId:"maintainfortNum",th:th,param:{pageNum:1},callback:function(a){for(var b,c=0,d=a.tr.length;d>c;c++)b=a.tr[c].status,a.tr[c].status=statusOpt[b].text}},thYuyue=[{id:"itemId",name:"推荐项目id",width:80},{id:"itemName",name:"推荐项目名称",width:""},{id:"workType",name:"工种",width:""},{id:"faultCode",name:"错误代码",width:""},{id:"standardWorkTime",name:"标准工时",width:""},{id:"standardUnitPrice",name:"标准单价",width:""},{id:"coastWorkTime",name:"工时花费"}],thLingliao=[{id:"productID",name:"商品编码"},{id:"productname",name:"商品名称"},{id:"unit",name:"单位"},{id:"productnum",name:"数量",isEdit:!0},{id:"unitprice",name:"单价",isEdit:!0},{id:"teams",name:"领料班组",isEdit:!0},{id:"maintenanceMan",name:"领料人",isEdit:!0}],thDanju=[{id:"maintainID",name:"预约单号"},{id:"checker",name:"检测人"},{id:"checkDate",name:"检测时间",dataType:"time"},{id:"Accounter",name:"结算人"},{id:"accountDate",name:"结算时间",dataType:"time"},{id:"checkout",name:"收银人"},{id:"checkoutDate",name:"收银时间",dataType:"time"},{id:"completionDate",name:"完工时间",dataType:"time"},{id:"Outmaker",name:"出厂时间",dataType:"time"},{id:"Header",name:"负责人"}],thFeiyong=[{id:"laborCost",name:"工时费"},{id:"materiaCost",name:"材料费"},{id:"otherCost",name:"其他费"},{id:"pageName",name:"套餐"},{id:"totalCost",name:"合计"}],thxmll=[{id:"productID",name:"商品编号"},{id:"productname",name:"商品名称"},{id:"origin",name:"产地"},{id:"type",name:"分类"},{id:"carModle",name:" 车型"},{id:"lastdeliveryDate",name:"最近出货时间"},{id:"lastpurchaseDate",name:" 最近进货时间"},{id:"account",name:"商品可售数量"},{id:"unit",name:"单位（升，个）"},{id:"safeaccount",name:"安全数量"},{id:"suggestBuyprice",name:"建议购买价格"},{id:"suggestSaleprice",name:" 建议销售价格"},{id:"repertory",name:"仓库名称"}],yuyuexiangmu={id:"childTable",port:"serviceItemList.do",addport:"serviceItemInput.do",saveport:"serviceItemDoSave.do",isOpt:!1,isCheck:!0,th:thYuyue,thadd:thYuyue,btntype:1,param:{pageNum:1}},xiangmulingliao={id:"childTable",port:"usedCompontList.do",addport:"usedCompontInput.do",saveport:"usedCompentDoSave.do",isOpt:!1,th:thLingliao,thadd:thxmll,param:{pageNum:1}},danjuxinxi={itemId:"mainId",isJump:!0,editport:"orderdetail.do",saveport:"orderdetail.do",editItem:[{id:"maintainID",name:"预约单号",value:""},{id:"checker",name:"检测人",value:""},{id:"checkDate",name:"检测时间",value:"",dataType:"time"},{id:"Accounter",name:"结算人",value:""},{id:"accountDate",name:"结算时间",value:"",dataType:"time"},{id:"checkout",name:"收银人",value:""},{id:"checkoutDate",name:"收银时间",value:"",dataType:"time"},{id:"completionDate",name:"完工时间",value:"",dataType:"time"},{id:"Outmaker",name:"出厂时间",value:"",dataType:"time"},{id:"Header",name:"负责人",value:""}],callback:function(a){a.status&&$("span.fred","div.opt-tit").html(statusOpt[a.status].text)}},feiyongheji={id:"childTable",port:"costsheet.do",th:thFeiyong,param:{pageNum:1}},editObj={itemId:"mainId",editport:"maintainformDetail.do",saveport:"maintainformSaveOrUpdate.do",editItem:[{id:"maintainfortNum",name:"维修单ID",value:""},{id:"truename",name:"姓名",value:""},{id:"phone",name:"手机",value:"",dataType:"phone"},{id:"qqid",name:"QQ",value:"",dataType:"qq"},{id:"custDept",name:"客户单位",value:""},{id:"address",name:"地址",value:""},{id:"brand",name:"品牌",value:"",click:a},{id:"series",name:"车系",value:"",click:a},{id:"platenumber",name:"车牌",value:"",dataType:"plate"},{id:"color",name:"颜色",type:1,selected:"0",options:colorOpt},{id:"motorNumber",name:"发动机码",value:""},{id:"motorNumber",name:"底盘号",value:""},{id:"miles",name:"公里数",value:"",dataType:"number"},{id:"oil",name:"油表状态",value:"",type:1,selected:"0",options:oilOpt},{id:"maintaintype",name:"维修类型",type:1,selected:"美容",options:classOpt},{id:"receiveCar",name:"接车员",value:""},{id:"arriveTime",name:"接车时间",value:"",dataType:"time"},{id:"exeptTime",name:"预计时间",value:"",dataType:"time"},{id:"status",name:"状态",type:1,selected:"0",options:statusOpt}],callback:function(a){a.status&&$("span.fred","div.opt-tit").html(statusOpt[a.status].text)}},e){COMMON.loadData.series(),COMMON.loadData.brand(),COMMON.addTpl({table:1,th:th}),COMMON.addTpl({edit:1}),"add"==f?COMMON.edit("edit",editObj):COMMON.edit("edit",editObj),avalon.scan();var g={port:"usedCompontInput.do",obj:COMMON.defaultParam,isFold:!1};TREE.tree($("div.tree"),g);var h=[yuyuexiangmu,xiangmulingliao,danjuxinxi,feiyongheji];child=avalon.define("childTable",function(a){a.tab=["预约项目","项目领料","单据信息","费用合计","项目进度"],a.curIndex=0,a.th=[],a.tr=[],a.item=[],a.newData=[],a.isCheck=a.curIndex.isCheck===!0?!0:!1,a.nodata='<img src="img/loading.gif"/>',a.isOpt=!0,a.changeIndex=function(b,c){var d=a;if(d.curIndex=b,2!=b){var e=h[b],f={mainId:COMMON.getQuery("id")};d.th.removeAll(),4==d.curIndex?COMMON.getProcess():(d.th.pushArray(e.th),COMMON.ajaxFn({url:e.port,obj:f,callback:function(a){if(1==a.code){var b=null;if(d.tr=[],$loading=$("tr.loading"),a.data){if(b=a.data,3==d.curIndex&&b.recommendItem&&(b.pageName=b.recommendItem.pageName),b.length<1)$loading.show(),d.nodata="暂无数据";else{if(b.data?b=b.data||{}:($loading.show(),d.nodata="暂无数据"),b instanceof Array)d.tr=b||[];else{var f=[];f.push(b),d.tr=f}if(0==d.curIndex)for(var g=0,h=$("tr","table tbody").length;h>g;g++)$("tr","table tbody").eq(g).find("a").last().hide();$loading.hide()}var i=a.data.total||"";i&&$("div.page").pager({pageNumber:c,pageTotal:i,change:function(a){e.pageNum=a,d.changeIndex(g)}})}else $loading.show(),d.nodata="暂无数据"}}}))}},a.getkey=function(a,b){var c=child;if(2!=c.curIndex&&c.tr.size()>0&&child.tr[a]){for(var d=(child.tr[a][b],h[c.curIndex].th),e=null,f=null,g=0,i=d.length;i>g;g++)if(f=d[g],f.id==b&&"time"==f.dataType)return e=c.tr[a][b]||new Date,new Date(e).toLocaleDateString();return c.tr[a][b]}},a.getId=function(a,b){var c=child;return c.tr.size()>0&&c.tr[a]?"javascript:;":void 0},a.addItem=function(){$("div.bd",$winpop).hide(),$("div.addyyxm",$winpop).show(),$winpop.dialog("show"),b(child.curIndex),$("#tree").on("click","a",function(){b(child.curIndex,{itemName:$(this).html()})})},a.delItem=function(b){var c=h[a.curIndex],d=a.tr[b][c.itemId],e={};$dialog.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(b){e[c.itemId]=d,e=$.extend({},defaultParam,e),COMMON.ajaxFn({url:c.delport,obj:e,callback:function(c){1==c.code&&(b.dialog("hide"),a.changeIndex(a.curIndex))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}});var i=avalon.define("table_list",function(a){a.th=[],a.tr=[],a.search={itemId:"",itemName:""},a.isOpt=!1,a.isCheck=!0,a.nodata='<img src="img/loading.gif"/>',a.getkey=function(a,b){var c=i;return c.tr.size()>0&&c.tr[a]?c.tr[a][b]:void 0},a.getId=function(a,b){var c=child;return c.tr.size()>0&&c.tr[a]?"javascript:;":void 0},a._thInit=function(a){var b=this;return"width:"+b.th.width},a.saveItem=function(){for(var a=[],b=$("input:checkbox",$winpop),c=null,d=child.curIndex,e=h[d].saveport,f=0,g=b.length;g>f;f++)c=b.eq(f).parent().next("td").text(),b.eq(f).attr("checked")&&a.push(c);COMMON.ajaxFn({url:e,obj:{mainId:id,itemIds:a.join(";")},callback:function(a){$winpop.dialog("hide"),child.changeIndex(d)}})},a.searchFn=function(){var a={itemId:$("#itemId").val()||"",itemName:$("#itemName").val()||""};b(child.curIndex,a)}});avalon.scan(),child.changeIndex(0),COMMON.edit("dd",danjuxinxi),c()}else COMMON.addTpl({table:1,th:th}),COMMON.table(tableObj)});