$(function(){function a(){$.extend({},g,{pageNum:1,pageSize:10});k=avalon.define({$id:"useredit",itemId:"id",item:h.editItem,roles:[],newData:n,change:function(a){"repassword"==$(a.target).attr("id")&&(a.target.value!=$("#password").val()?$(".error",l).size()>0?$(".error",l).show():$(".bd",l).append('<div class="error">与密码不一致</div>'):$(".error",l).hide()),n[a.target.getAttribute("id")]=a.target.value},cancelItem:function(){c()},getRole:function(){COMMON.ajaxFn({url:"roleList.do",obj:{pageSize:10,pageNum:1},callback:function(a){for(var b=a.data.data||[],c=[],d=0,e=b.length;e>d;d++)c.push({text:b[d].name,value:b[d].id});for(var f=0,g=k.item.length;g>f;f++)"roles"==k.item[f].id&&(k.item[f].options=c||[],k.item[f].selected=b[1].id)}}),COMMON.ajaxFn({url:"listDeptByPage.do",obj:{pageSize:10,pageNum:1},callback:function(a){for(var b=a.data.data||[],c=[],d=0,e=b.length;e>d;d++)c.push({text:b[d].departmentName,value:b[d].departmentName});k.item[1].options=c||[],k.item[1].selected=b[0].departmentName}})},saveItem:function(){var a=$("div.bd-user",l);n.name=$("#name",a).val(),n.departmentName=$("#dept",a).val(),n.account=$("#account",a).val(),n.role_ids=$("#roles",a).val()?$("#roles",a).val().join(","):"",n.duty=$("#duty",a).val(),k.newData=n,COMMON.ajaxFn({url:"saveOrUpdateUsers.do",obj:k.newData,callback:function(b){if(1==b.code){var e=$("div.dialog");$("div.item",e);d(),c();for(var f=0,g=$("div.item","div.dialog").length;g>f;f++);$("#name",a).val("")}}})}}),j=avalon.define({$id:"table",th:f,tr:[],ids:[],isOpt:!0,rolename:[],rolenames:[],getkey:function(a,b){return j.tr.size()>0&&j.tr[a]?j.tr[a][b]:void 0},addItem:function(a){b("user","add")},editItem:function(a){$("div.bd-role",l).hide(),$("div.bd-user",l).hide(),b("user","edit",a),n.id=a},delItem:function(a){$("div.winpop").dialog({title:"窗口提示",content:"确定删除此条数据吗",button:[{text:"确定",cls:" btn-ok",handler:function(b){COMMON.ajaxFn({url:"deleteUsersById.do",obj:{id:a},callback:function(a){1==a.code?(d(),b.dialog("hide")):alert("删除失败")}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}]})}}),d()}function b(a,b,c,d){var e="add"==b?"添加用户":"编辑用户",f="",g=$("div.winpop"),l=$("div.bd-role",g),n=$("div.bd-user",g);if($("div.hd",g).html(e),"user"==a&&(f=i.port,n.show(),l.hide()),g.show(),m.show(),"add"!=b){$("#account").parent().parent().hide(),$("#password").parent().parent().hide(),$("#repassword").parent().parent().hide();var o={},p={},q={},r=null,s=null,t={},u=[];if("user"==a){for(var v=0,w=j.tr.length;w>v;v++)j.tr[v].id==c&&(o=j.tr[v],v=w);p=h.editItem;for(var x=0,y=p.length;y>x;x++){if(r=p[x].id,"roles"==r){t=o[r];for(var z=0,A=t.length,u=[];A>z;z++)u.push(t[z].id);k.item[x].selected=u,q[r]=u}else"dept"==r?(s=o[r],p[1].selected=s,k.item[1].selected=s):(s=o[r]||"",k.item[x].value=s);q[r]=s}q.id=c,k.newData=q}g.show(),m.show()}else{$("#account").parent().parent().show(),$("#password").parent().parent().show(),$("#repassword").parent().parent().show();for(var x=0,y=h.editItem.length;y>x;x++)k.item[x].value=""}}function c(){l.hide(),m.hide()}function d(a){var b=null,c=null;b=$.extend({},g,i.param),c=i.port,COMMON.ajaxFn({url:c,obj:b,callback:function(b){if(1==b.code){var c=b.data||{};$("tr.loading").hide(),"role"==a||(c?(c.data&&c.data.length>0?(j.tr=c.data,$("tr.loading").hide()):e(),c.total&&c.total>1?$("div.page").show():$("div.page").hide()):e())}}})}function e(){$("tr.loading td").html("暂无数据"),$("tr.loading").show()}var f=[{id:"name",name:"姓名"},{id:"account",name:"账号"}],g={facilitatorID:COMMON.getCookie("facilitatorID")||1,companyUserID:COMMON.getCookie("companyUserID")||1},h={itemId:"id",editItem:[{id:"name",name:"姓名",value:"1",type:0},{id:"dept",name:"部门",value:"",type:1,selected:"",options:[]},{id:"account",name:"账号",value:""},{id:"password",name:"密码",value:""},{id:"repassword",name:"确认密码",value:""},{id:"roles",name:"关联角色名称",type:1,selected:[],options:[],isMulti:!0}]},i={id:"table",port:"listUsersByPage.do",saveport:"saveOrUpdateUsers.do",delport:"deleteUsersById.do",itemId:"id",th:f,param:{pageNum:1,pageSize:10}},j=null,k=null,l=$("div.winpop"),m=$("div.mask"),n={};a()});