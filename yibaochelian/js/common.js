var COMMON=function(){function h(a,b){var c=30,d=new Date;d.setTime(d.getTime()+1e3*60*60*24*c),document.cookie=a+"="+escape(b)+";expires="+d.toGMTString()}function j(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function k(a){var b,c,d,e,g,h;if(-1===f.indexOf("?")||-1===f.indexOf(a+"="))return"";for(b=f.substring(f.indexOf("?")+1),-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#"))),c=b.split("&"),h=0;h<c.length;h++)if(d=c[h].indexOf("="),-1!==d&&(e=c[h].substring(0,d),g=c[h].substring(d+1),e===a))return g.replace(/\+/g," ");return""}function l(){var b,c,a=["index","yuyuejiedai","weixiujiedai","weixiulingliao","chejianguanli","kufangguanli","kehuguanli","yonghuguanli","caiwuguanli","xitongguanli"];for(b=0,c=a.length;c>b;b++)f.indexOf(a[b])>0&&$("a","div.mainnav").removeClass("on").eq(b).addClass("on")}function m(a){var d=a.id||"table",h=a.param,i=a.id||"model";e=avalon.define(i,function(b){b.$id=d,b.itemId=a.itemId,b.th=a.th,b.tr=[],b.isOpt=a.isOpt===!1?!1:!0,b.nodata='<img src="img/loading.gif"/>',b.getkey=function(c,d){if(f.indexOf("index.html")>-1&&"state"==d)return'<img src="img/status'+b.tr[c][d]+'.png" />';if(b.tr.size()>0&&b.tr[c]){if(a.th[c].time){var e=b.tr[c][d];return new Date(e).toLocaleDateString()}return b.tr[c][d]}},b.getId=function(c){var g,h,e=b;return e.tr.size()>0&&e.tr[c]&&1!=a.btntype?(g=f.split("/"),h=g[g.length-1].split(".html")[0]||"index",h+"-opt.html?id="+e.tr[c][e.itemId]):void 0},b.getNum=function(a){var d,e,b=$("tr",$("table.Mtable")),c=null;for(d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},b.delItem=function(d){var e=b.tr[d][a.itemId],f={};g.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(d){f[a.itemId]=e,f=$.extend({},c,f),q({url:a.delport,obj:f,callback:function(c){1==c.code&&(d.dialog("hide"),b.getTr(a.port,h,a.callback))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},b.addItem=function(){if(1==a.btntype)$("div.dialog").dialog("show"),"function"==typeof a.callback&&a.callback();else{var b=f.split("/"),c=b[b.length-1].split(".html")[0]||"index";f.indexOf("weixiujiedai")>-1?q({url:a.addport,obj:{},callback:function(a){1==a.code&&(location.href=c+"-opt.html?id="+a.data.mainId)}}):location.href=c+"-opt.html"}},b.getTr=function(){n(a.port,h,a.callback)},b.searchItem=function(){var c=$("div.search");h[$("span.select",c).attr("data-id")]=$("input.inpt-search",c).val(),b.getTr(a.port,h,a.callback)}}),avalon.scan()}function n(b,d,g){d=$.extend({},c,d||{}),curpage=d.pageNum,d.pageSize=10,q({url:b,obj:d,callback:function(c){var h,i,j,m,k,l,n;if(1==c.code||1==c.ret){if(h=c.data||{},i=null,j=$("tr.loading"),"[object Array]"==a.call(h)){if(!(h.length>0))return e.nodata="暂无数据",j.show(),void 0;i=h}else if("[object Object]"==a.call(h)){if(!c.data)return e.nodata="暂无数据",j.show(),void 0;if(!c.data.data)return e.nodata="暂无数据",j.show(),void 0;i=h.data||{}}if(j.hide(),f.indexOf("yuyuejiedai")>-1)for(k=0,l=i.length;l>k;k++)m=i[k],m.maintainform&&(i[k]=$.extend({},m.maintainform||{},m));e.tr=[],e.tr=i||{},"function"==typeof g&&g(e),pageTotal=c.data["total"]||"",pageTotal&&(n=pageTotal,$("div.page").pager({pageNumber:curpage,pageTotal:n,change:function(a){d.pageNum=a,o(b,d,function(){e.getNum(a)})}}))}}})}function o(a,b,c){n(a,b,c)}function p(a,b){var a=a||"edit",d=null,e={},g={status:0};f.indexOf("xitongguanli")>-1&&(g={}),g[b.itemId]=k("id"),k("id")&&(b.id&&(g[b.id]=k("id")),f.indexOf("kufangguanli")>-1&&(g=$.extend({},{pageNumber:1,pageSize:10},g)),q({url:b.editurl||b.editport,obj:g,callback:function(a){var c,g,h,i,j;if(1==a.code){if(c=b.editItem,g="",h=a.data||{},b.edittype&&(h=h.length>0?h[0]||{}:h.data[0]||{}),f.indexOf("yuyuejiedai")>-1&&(h=$.extend({},h.maintainform||{},h)),h){for(i=0,j=c.length;j>i;i++)g=c[i]["id"],(f.indexOf("index")>-1||f.indexOf("weixiujiedai")>-1)&&"maintainfortNum"==g?(editItemVal=k("id"),d.item[i].value=editItemVal,e["mainId"]=editItemVal):(editItemVal=h[g],d.item[i].value=editItemVal,e[g]=editItemVal,c[i]["option"]&&(d.selected=editItemVal));"function"==typeof b.callback&&b.callback(h)}}else $("div.opt").html(a.message||"数据不存在")}})),d=avalon.define({$id:a,item:b.editItem,newData:e,change:function(a){a.target.getAttribute("data-id")==b.itemId?e["mainId"]=a.target.value:e[a.target.getAttribute("data-id")]=a.target.value},data:[],dialogData:function(a,b){b&&(obj=$.extend({},c,b.param||{}),q({url:b.url,obj:obj,callback:function(b){var c,d,f,g,h;if(1==b.code&&(c=[],b.data)){for(d=b.data.data||{},f="",g=0,h=d.length;h>g;g++)f=d[g][a],c.push(['<span class="label">','<input type="radio" value="'+f+'" />'+f,"</span>"].join(""));$("div.dialog").dialog({title:"修改窗口",content:c.join(""),button:[{text:"确定",cls:"btn-ok",handler:function(b){$(".bd input",b),$("input[data-id="+a+"]").val($("input:checked",b).val()),e[a]=$("input:checked",b).val(),b.dialog("hide")}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("dialog-select")}})}}}))},addItem:function(){var f,g,a=b.addurl||b.addport;if(a)q({url:a,obj:c,callback:function(a){var c,f,g,h;if(1==a.code){for(c=b.itemId,f=a.data||{},e={},e[c]=f[c]||"&nbsp;",g=0,h=b.editItem.length;h>g;g++)b.editItem[g]["value"]="";b.editItem[c]=f[c],d.item=b.editItem}}});else for(f=0,g=b.editItem.length;g>f;f++)b.editItem[f].value="",e[b.editItem[f].name]=""},saveItem:function(){if(d.modifyId(),f.indexOf("kehuguanli-opt")>-1){var a={};a.id=k("id"),a.carOwner=e.carOwner,a.carNum=e.carNum,a.carType=e.carType,e=a}e[b.itemId]=k("id"),q({url:b.saveurl||b.saveport,type:"POST",obj:e,callback:function(a){1==a.code?$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide"),location.href=k("type")?(f.substring(0,f.indexOf("-opt"))||"index")+".html?type="+k("type"):(f.substring(0,f.indexOf("-opt"))||"index")+".html"}}],callback:function(a){a.addClass("w400")}}):$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})},cancelItem:function(){for(i in e)"maintainfortNum"==i&&(e["mainId"]=e[i],delete e[i]);q({url:b.cancelport,type:"POST",obj:e,callback:function(a){1==a.code?location.href=(f.substring(0,f.indexOf("-opt"))||"index")+".html":alert("取消失败")}})},modifyId:function(){(f.indexOf("index")>-1||f.indexOf("weixiujiedai")>-1)&&e.maintainfortNum&&(e.mainId=e.maintainfortNum),f.indexOf("chejianguanli")>-1&&e.appointmentNum&&(e.maintainID=e.appointmentNum)}})}function q(a){if(a){a.obj&&!a.obj.facilitatorID&&(a.obj.facilitatorID=j("facilitatorID")||1),a.obj&&!a.obj.companyUserID&&(a.obj.companyUserID=j("companyUserID")||1);var c=a.type||"GET",d=b.URL;a.url&&(a.url&&a.url.indexOf("role")>-1&&(d=d.replace("enterprise/","")),$.ajax({url:d+a.url,type:c,data:a.obj,dataType:"jsonp",success:function(b){1==b.code||1==b.ret?a.callback(b):$(".loading").html("暂无数据")},error:function(){$(".loading").html("暂无数据")}}))}}function r(){var c,d,a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c).attr("data-id",$(this).attr("data-id")),b.hide()}),c=$("span","div.tabs"),d=$("div.item","div.tabcon"),c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this),b=$("div.reg");b.removeClass("on"),"person"==a.attr("data-type")?b.eq(0).addClass("on"):b.eq(1).addClass("on")}),$("div.dialog,div.winpop").on("click","a.close",function(){$("div.dialog,div.winpop").hide()}).on("click","a.btn-cancel",function(){$("div.dialog,div.winpop").hide()})}function s(){$("div.search").on("click","a.btn-search",function(a,b,c){q({url:a,obj:b,callback:c})})}function t(a){var b=[],c=[],d=[],f=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>",'<th width="80">序号</th>','<th ms-repeat="th" ms-attr-width="el.width">{{el.name}}</th>','<th ms-if-loop="isOpt" width="100">操作</th>',"</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="30" style="height:150px;padding-top:50px;" ms-duplex="nodata"></td>',"</tr>",'<tr ms-repeat="tr">',"<td>{{$index+1}}</td>",'<td ms-repeat="th" ms-data-id="el.id" ms-html="getkey($outer.$index,el.id)"></td>','<td ms-if-loop="isOpt"><a class="edit-item" ms-href="getId($index)" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),f.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >','<label><span class="fred"  ms-if-loop="el.ismust">* </span>{{el.name}}：</label> ','<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-data-id="el.id" ms-attr-data-id="el.id" ms-attr-value="el.value" ms-on-input="change" ms-click="dialogData(el.id,el.click)"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-id="el.name" ms-attr-value="el.value">','<select class="select" ms-duplex="el.selected" ms-attr-id="el.id">','<option ms-repeat="el.options" ms-attr-value="el.value" >{{el.text}}</option>',"</select>","</span>",'<span ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-data-id="el.id" ms-attr-value="el.value" class="remark"></textarea></div>',"</span>","</script>"].join("")),f.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),f.append(d))}function v(){var b=null;q({url:"progressionBar.do",obj:{mainId:k("id")},callback:function(a){if(1==a.code){$("p",u).removeClass("on over");for(var c=1,d=$("p",u).length;d>c;c++){if(b=$("p.step"+c,u),a.data.processNum==b.attr("data-id"))return b.addClass("on"),void 0;b.addClass("over")}}}})}function w(a){var b={mainId:k("id"),processNum:a};COMMON.ajaxFn({url:"progressionBarSaveOrUpdate.do",obj:b,callback:function(b){var c="";c=1==b.code?"修改成功":"修改失败",g.dialog({title:"确认提示",content:c,button:[{text:"确认",cls:"btn-ok",handler:function(){g.dialog("hide")}}],callback:function(b){if("修改成功"==c){$("p",u).removeClass("on over");for(var d=0,e=$("p",u).length;e>d;d++)a>d&&$("p.step"+d,u).addClass("over");$("p.step"+a,u).addClass("on")}setTimeout(function(){b.dialog("hide")},2e3)}})}})}var a=Object.prototype.toString,b={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","正修","已修","内部交车","结算","交车"],CLASS:["保养","维修","美容"]},c={facilitatorID:j("facilitatorID")||1,companyUserID:j("companyUserID")||1},e=null,f=document.location.href,g=$("div.dialog"),u=$("div.process");return u.on("click","p",function(){var a=$(this),b=a.index()+1,c=$("div.dialog");c.dialog({title:"确认修改流程",content:"确定要修改到当前状态吗？",button:[{text:"确定",cls:"btn-ok",handler:function(a){var b=a.attr("data-id");w(b)}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(){var a=$("div.dialog");a.addClass("auto"),a.attr("data-id",b)}})}),{init:function(){l(),r()},OBJ:b,table:m,getTr:n,edit:p,addTpl:t,ajaxFn:q,search:s,getQuery:k,gettype:a,getCookie:j,setCookie:h,getProcess:v,defaultParam:c}}();$(function(){COMMON.init()});