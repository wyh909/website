var COMMON=function(){function e(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function f(a){var b,c,d,e,f,g;if(-1===location.href.indexOf("?")||-1===location.href.indexOf(a+"="))return"";for(b=location.href.substring(location.href.indexOf("?")+1),-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#"))),c=b.split("&"),g=0;g<c.length;g++)if(d=c[g].indexOf("="),-1!==d&&(e=c[g].substring(0,d),f=c[g].substring(d+1),e===a))return f.replace(/\+/g," ");return""}function g(){}function h(a,d,e){d=$.extend({},b,d||{}),curpage=d.pageNum,d.pageSize=10,COMMON.ajaxFn({url:a,obj:d,callback:function(b){if(1==b.code){if(!b.data)return;var f=b.data.data||{},g=b.data["total:"];c.tr=f||{},"function"==typeof e&&e(),$("div.page").pager({pageNumber:curpage,pageTotal:g,change:function(b){d.pageNum=b,i(a,d,function(){c.getNum(b)})}})}}})}function i(a,b,c){h(a,b,c)}function j(a){var d=a.id||"table",e=a.param;c=avalon.define({$id:d,itemId:a.itemId,th:a.th,tr:[],getkey:function(a,b){return c.tr.size()>0&&c.tr[a]?c.tr[a][b]:void 0},getId:function(a){var b,d;return c.tr.size()>0&&c.tr[a]?(b=document.location.href.split("/"),d=b[b.length-1].split(".html")[0],d+"-opt.html?id="+(c.tr[a][c.itemId]||"")):void 0},getNum:function(a){var d,e,b=$("tr",$("table.Mtable")),c=null;for(d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},delItem:function(d){var f=c.tr[d][a.itemId],g={};g[a.itemId]=f,g=$.extend({},b,g),l({url:e.delport,obj:g,callback:function(b){1==b.code&&j(a)}})}}),h(a.port,e)}function k(a,c){var a=a||"edit",d=null,e={},g={};g[c.itemId]=f("id"),f("id")&&l({url:c.editurl,obj:g,callback:function(a){var b,f,g,h;if(1==a.code&&(b=c.editItem,f="",a.data))for(g=0,h=b.length;h>g;g++)f=b[g]["id"],editItemVal=a.data[f],d.item[g].value=editItemVal,e[f]=editItemVal,b[g]["option"]&&(d.selected=editItemVal)}}),d=avalon.define({$id:a,item:c.editItem,newData:e,change:function(a){e[a.target.getAttribute("data-id")]=a.target.value},selected:"",addItem:function(){var a=c.addurl;l({url:a,obj:b,callback:function(a){if(1==a.code){e={},e[c.itemId]=a.data[c.itemId];for(var b=0,f=c.editItem.length;f>b;b++)c.editItem[b]["value"]="";d.item=c.editItem}}})},saveItem:function(){l({url:c.saveurl,type:"POST",obj:e,callback:function(){1==json.code&&alert("提交成功")}})}})}function l(b){if(b){b.obj&&!b.obj.facilitatorID&&(b.obj.facilitatorID=e("facilitatorID")||1),b.obj&&!b.obj.companyUserID&&(b.obj.companyUserID=e("companyUserID")||1);var c=b.type||"GET";b.url&&$.ajax({url:a.URL+b.url,type:c,data:b.obj,dataType:"jsonp",success:function(a){1==a.code&&(b.callback(a),setTimeout(function(){$("tr.loading").hide()},100)),1!=a.code&&$(".loading").html("暂无数据")},error:function(){$(".loading").html("暂无数据")}})}}function m(){var c,d,a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c),b.hide()}),c=$("span","div.tabs"),d=$("div.item","div.tabcon"),c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this);"person"==a.attr("data-type")?$("div.reg").hide().eq(0).show():$("div.reg").hide().eq(1).show()}),$("div.tree").on("click","span",function(){var a=$(this);a.hasClass("open")?a.removeClass("open").addClass("close").parent().next("ul").hide():a.removeClass("close").addClass("open").parent().next("ul").show()})}function n(){$("div.search").on("click","a.btn-search",function(a,b,c){l({url:a,obj:b,callback:c})})}function o(a){var b=[],c=[],d=[],f=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>","<th>序号</th>",'<th ms-repeat="th">{{$val}}</th>',"<th>操作</th>","</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="10"><img src="img/loading.gif"/></td>',"</tr>",'<tr ms-repeat="tr">',"<td>{{$index+1}}</td>",'<td ms-repeat="th" ms-data="getkey($index,$key)">{{getkey($index,$key)}}</td>','<td><a class="edit-item" ms-href="getId($index)" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),f.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >',"<label>{{el.name}}：</label> ",'<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-data-id="el.id" ms-attr-value="el.value" ms-on-input="change"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-value="el.value">','<select class="select" ms-duplex="selected">','<option ms-repeat="el.option" >{{el}}</option>',"</select>","</span>",'<div class="detail"  ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-value="el.value" class="user-detail"></textarea></div>',"</div>","</script>"].join("")),f.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),f.append(d))}var a={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","在修","已修","内部交车","结算","交车"],th0:{maintainfortNum:"维修单号",truename:"真实姓名",platenumber:"车牌号",phone:"电话",maintaintype:"类别",status:"状态"},th1:[]},b={facilitatorID:e("facilitatorID")||1,companyUserID:e("companyUserID")||1},c=null;return{init:function(){g(),m()},OBJ:a,table:j,getTr:h,edit:k,addTpl:o,ajaxFn:l,search:n,getQuery:f}}();$(function(){COMMON.init()});