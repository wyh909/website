var COMMON=function(){function g(a,b){var c=30,d=new Date;d.setTime(d.getTime()+1e3*60*60*24*c),document.cookie=a+"="+escape(b)+";expires="+d.toGMTString()}function h(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function j(a){var b,c,d,e,g,h;if(-1===f.indexOf("?")||-1===f.indexOf(a+"="))return"";for(b=f.substring(f.indexOf("?")+1),-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#"))),c=b.split("&"),h=0;h<c.length;h++)if(d=c[h].indexOf("="),-1!==d&&(e=c[h].substring(0,d),g=c[h].substring(d+1),e===a))return g.replace(/\+/g," ");return""}function k(){var b,c,a=["index","yuyuejiedai","weixiujiedai","weixiulingliao","chejianguanli","jinchukuguanli","kehuguanli","yonghuguanli"];for(b=0,c=a.length;c>b;b++)f.indexOf(a[b])>0&&$("a","div.mainnav").removeClass("on").eq(b).addClass("on");$("span","div.tab").removeClass("on").eq(0).addClass("on"),$("div.item","div.tabcon").removeClass("on").eq(0).addClass("on")}function l(b,e,f){e=$.extend({},c,e||{}),curpage=e.pageNum,e.pageSize=10,p({url:b,obj:e,callback:function(c){if(1==c.code){var g=c.data||{},h=null;if("[object Array]"==a.call(g)){if(!(g.length>0))return $("td","tr.loading").html("暂无数据"),void 0;h=g}else if("[object Object]"==a.call(g)){if(!c.data||c.data&&!c.data.data)return $("td","tr.loading").html("暂无数据"),void 0;h=c.data.data||{}}pageTotal=c.data["total:"],$("tr.loading").hide(),d.tr=h||{},"function"==typeof f&&f(),$("div.page").pager({pageNumber:curpage,pageTotal:pageTotal,change:function(a){e.pageNum=a,m(b,e,function(){d.getNum(a)})}})}}})}function m(a,b,c){l(a,b,c)}function n(a){var b=a.id||"table",e=a.param;d=avalon.define({$id:b,itemId:a.itemId,th:a.th,tr:[],getkey:function(a,b){return d.tr.size()>0&&d.tr[a]?d.tr[a][b]:void 0},getId:function(a){var c,e;return d.tr.size()>0&&d.tr[a]?(c=f.split("/"),e=c[c.length-1].split(".html")[0]||"index",e+"-opt.html?id="+d.tr[a][d.itemId]):void 0},getNum:function(a){var d,e,b=$("tr",$("table.Mtable")),c=null;for(d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},delItem:function(b){var e=d.tr[b][a.itemId],f={};f[a.itemId]=e,f=$.extend({},c,f),p({url:a.delport,obj:f,callback:function(b){1==b.code&&n(a)}})}}),l(a.port,e)}function o(a,b){var a=a||"edit",d=null,e={},g={status:0};g[b.itemId]=j("id"),j("id")&&(b.id&&(g[b.id]=j("id")),p({url:b.editurl,obj:g,callback:function(a){var c,f,g,h,i;if(1==a.code&&(c=b.editItem,f="",g=a.data||{},b.edittype&&(g=g.length>0?g[0]||{}:g.data[0]||{}),g))for(h=0,i=c.length;i>h;h++)f=c[h]["id"],editItemVal=g[f],d.item[h].value=editItemVal,e[f]=editItemVal,c[h]["option"]&&(d.selected=editItemVal)}})),d=avalon.define({$id:a,item:b.editItem,newData:e,change:function(a){a.target.getAttribute("data-id")==b.itemId?e["mainId"]=a.target.value:e[a.target.getAttribute("data-id")]=a.target.value},selected:"",addItem:function(){var f,g,a=b.addurl;if(a)p({url:a,obj:c,callback:function(a){var c,f,g,h;if(1==a.code){for(c=b.itemId,f=a.data||{},e={},e[c]=f[c],g=0,h=b.editItem.length;h>g;g++)b.editItem[g]["value"]="";b.editItem[c]=f[c],d.item=b.editItem}}});else for(f=0,g=b.editItem.length;g>f;f++)b.editItem[f].value="",e[b.editItem[f].name]=""},saveItem:function(){for(i in e)i==b.itemId&&(e["mainId"]=e[i],delete e[i]);p({url:b.saveurl,type:"POST",obj:e,callback:function(a){1==a.code?(alert(a.message||"保存成功"),location.href=(f.substring(0,f.indexOf("-opt"))||"index")+".html"):alert("保存失败")}})}})}function p(a){if(a){a.obj&&!a.obj.facilitatorID&&(a.obj.facilitatorID=h("facilitatorID")||1),a.obj&&!a.obj.companyUserID&&(a.obj.companyUserID=h("companyUserID")||1);var c=a.type||"GET",d=b.URL;a.url.indexOf("role")>-1&&(d=d.replace("enterprise/","")),a.url&&$.ajax({url:d+a.url,type:c,data:a.obj,dataType:"jsonp",success:function(b){1==b.code?a.callback(b):$(".loading").html("暂无数据")},error:function(){$(".loading").html("暂无数据")}})}}function q(){var c,d,a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c),b.hide()}),c=$("span","div.tabs"),d=$("div.item","div.tabcon"),c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this);"person"==a.attr("data-type")?$("div.reg").hide().eq(0).show():$("div.reg").hide().eq(1).show()}),$("div.tree").on("click","span",function(){var a=$(this);a.hasClass("open")?a.removeClass("open").addClass("close").parent().next("ul").hide():a.removeClass("close").addClass("open").parent().next("ul").show()})}function r(){$("div.search").on("click","a.btn-search",function(a,b,c){p({url:a,obj:b,callback:c})})}function s(a){var b=[],c=[],d=[],f=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>","<th>序号</th>",'<th ms-repeat="th">{{$val}}</th>',"<th>操作</th>","</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="10" style="height:150px;padding-top:50px;"><img src="img/loading.gif"/></td>',"</tr>",'<tr ms-repeat="tr">',"<td>{{$index+1}}</td>",'<td ms-repeat="th" ms-data="getkey($index,$key)">{{getkey($index,$key)}}</td>','<td><a class="edit-item" ms-href="getId($index)" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),f.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >',"<label>{{el.name}}：</label> ",'<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-attr-id="el.id" ms-attr-value="el.value" ms-on-input="change"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-id="el.name" ms-attr-value="el.value">','<select class="select" ms-duplex="selected" ms-attr-id="el.id">','<option ms-repeat="el.option" >{{el}}</option>',"</select>","</span>",'<div class="detail"  ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-value="el.value" class="user-detail"></textarea></div>',"</div>","</script>"].join("")),f.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),f.append(d))}var a=Object.prototype.toString,b={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","在修","已修","内部交车","结算","交车"],th0:{maintainfortNum:"维修单号",truename:"真实姓名",platenumber:"车牌号",phone:"电话",maintaintype:"类别",status:"状态"},th1:[]},c={facilitatorID:h("facilitatorID")||1,companyUserID:h("companyUserID")||1},d=null,f=document.location.href;return{init:function(){k(),q()},OBJ:b,table:n,getTr:l,edit:o,addTpl:s,ajaxFn:p,search:r,getQuery:j,getCookie:h,setCookie:g}}();$(function(){COMMON.init()});