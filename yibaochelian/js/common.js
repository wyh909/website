var COMMON=function(){function setCookie(a,b){var c=30,d=new Date;d.setTime(d.getTime()+1e3*60*60*24*c),document.cookie=a+"="+escape(b)+";expires="+d.toGMTString()}function getCookie(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function getQueryString(a){var b,c,d,e,f,g;if(-1===href.indexOf("?")||-1===href.indexOf(a+"="))return"";for(b=href.substring(href.indexOf("?")+1),-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#"))),c=b.split("&"),g=0;g<c.length;g++)if(d=c[g].indexOf("="),-1!==d&&(e=c[g].substring(0,d),f=c[g].substring(d+1),e===a))return f.replace(/\+/g," ");return""}function domRender(){var b,c,a=["index","yuyuejiedai","weixiujiedai","weixiulingliao","chejianguanli","kufangguanli","kehuguanli","yonghuguanli","caiwuguali","xitongguanli"];for(b=0,c=a.length;c>b;b++)href.indexOf(a[b])>0&&$("a","div.mainnav").removeClass("on").eq(b).addClass("on")}function tableInit(a){var b=a.id||"table",c=a.param,d=a.id||"model";tableModel=avalon.define(d,function(d){d.$id=b,d.itemId=a.itemId,d.th=a.th,d.tr=[],d.nodata='<img src="img/loading.gif"/>',d.getkey=function(a,b){return d.tr.size()>0&&d.tr[a]?d.tr[a][b]:void 0},d.getId=function(b){var f,g,e=d;return e.tr.size()>0&&e.tr[b]&&1!=a.btntype?(f=href.split("/"),g=f[f.length-1].split(".html")[0]||"index",g+"-opt.html?id="+e.tr[b][e.itemId]):void 0},d.getNum=function(a){var d,e,b=$("tr",$("table.Mtable")),c=null;for(d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},d.delItem=function(b){var e=d.tr[b][a.itemId],f={};$dialog.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(b){f[a.itemId]=e,f=$.extend({},defaultParam,f),ajaxFn({url:a.delport,obj:f,callback:function(e){1==e.code&&(b.dialog("hide"),d.getTr(d,a.port,c,a.callback))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},d.addItem=function(){if(1==a.btntype)$("div.dialog").dialog("show"),"function"==typeof a.callback&&a.callback();else{var b=href.split("/"),c=b[b.length-1].split(".html")[0]||"index";href.indexOf("weixiujiedai")>-1?ajaxFn({url:a.addport,obj:{},callback:function(a){1==a.code&&(location.href=c+"-opt.html?id="+a.data.mainId)}}):location.href=c+"-opt.html"}},d.getTr=function(){getTr(d,a.port,c,a.callback)},d.searchItem=function(){var b=$("div.search");c[$("span.select",b).attr("data-id")]=$("input.inpt-search",b).val(),getTr(d,a.port,c,a.callback)}}),avalon.scan()}function getTr(a,b,c,d){c=$.extend({},defaultParam,c||{}),curpage=c.pageNum,c.pageSize=10,ajaxFn({url:b,obj:c,callback:function(e){var f,g,j,h,i;if(1==e.code||1==e.ret){if(f=e.data||{},g=null,"[object Array]"==gettype.call(f)){if(!(f.length>0))return a.nodata="暂无数据",void 0;g=f}else if("[object Object]"==gettype.call(f)){if(!e.data||e.data&&!e.data.data)return a.nodata="暂无数据",void 0;g=f.data||{}}if($("tr.loading").hide(),href.indexOf("yuyuejiedai")>-1)for(h=0,i=g.length;i>h;h++)j=g[h],j.maintainform&&(g[h]=$.extend({},j.maintainform||{},j));a.tr=[],a.tr=g||{},"function"==typeof d&&d(a),pageTotal=e.data["total"]||"",pageTotal&&$("div.page").pager({pageNumber:curpage,pageTotal:pageTotal,change:function(a){c.pageNum=a,getData(b,c,function(){tableModel.getNum(a)})}})}}})}function getData(a,b,c){getTr(a,b,c)}function editInit(a,b){var a=a||"edit",c=null,d={},e={status:0};e[b.itemId]=getQueryString("id"),getQueryString("id")&&(b.id&&(e[b.id]=getQueryString("id")),ajaxFn({url:b.editurl||b.editport,obj:e,callback:function(a){var e,f,g,h,i;if(1==a.code){if(e=b.editItem,f="",g=a.data||{},b.edittype&&(g=g.length>0?g[0]||{}:g.data[0]||{}),href.indexOf("yuyuejiedai")>-1&&(g=$.extend({},g.maintainform||{},g)),g){for(h=0,i=e.length;i>h;h++)f=e[h]["id"],(href.indexOf("index")>-1||href.indexOf("weixiujiedai")>-1)&&"maintainfortNum"==f?(editItemVal=getQueryString("id"),c.item[h].value=editItemVal,d["mainId"]=editItemVal):(editItemVal=g[f],c.item[h].value=editItemVal,d[f]=editItemVal,e[h]["option"]&&(c.selected=editItemVal));"function"==typeof b.callback&&b.callback(g)}}else $("div.opt").html(a.message||"数据不存在")}})),c=avalon.define({$id:a,item:b.editItem,newData:d,change:function(a){a.target.getAttribute("data-id")==b.itemId?d["mainId"]=a.target.value:d[a.target.getAttribute("data-id")]=a.target.value},selected:"",addItem:function(){var e,f,a=b.addurl||b.addport;if(a)ajaxFn({url:a,obj:defaultParam,callback:function(a){var e,f,g,h;if(1==a.code){for(e=b.itemId,f=a.data||{},d={},d[e]=f[e]||"&nbsp;",g=0,h=b.editItem.length;h>g;g++)b.editItem[g]["value"]="";b.editItem[e]=f[e],c.item=b.editItem}}});else for(e=0,f=b.editItem.length;f>e;e++)b.editItem[e].value="",d[b.editItem[e].name]=""},saveItem:function(){if(c.modifyId(),href.indexOf("kehuguanli-opt")>-1){var a={};a.id=getQueryString("id"),a.carOwner=d.carOwner,a.carNum=d.carNum,a.carType=d.carType,d=a}ajaxFn({url:b.saveurl||b.savaport,type:"POST",obj:d,callback:function(a){1==a.code?$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide"),location.href=(href.substring(0,href.indexOf("-opt"))||"index")+".html"}}],callback:function(a){a.addClass("w400")}}):$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})},cancelItem:function(){for(i in d)"maintainfortNum"==i&&(d["mainId"]=d[i],delete d[i]);ajaxFn({url:b.cancelport,type:"POST",obj:d,callback:function(a){1==a.code?location.href=(href.substring(0,href.indexOf("-opt"))||"index")+".html":alert("取消失败")}})},modifyId:function(){(href.indexOf("index")>-1||href.indexOf("weixiujiedai")>-1)&&d.maintainfortNum&&(d.mainId=d.maintainfortNum),href.indexOf("chejianguanli")>-1&&d.appointmentNum&&(d.maintainID=d.appointmentNum)}})}function ajaxFn(a){if(a){a.obj&&!a.obj.facilitatorID&&(a.obj.facilitatorID=getCookie("facilitatorID")||1),a.obj&&!a.obj.companyUserID&&(a.obj.companyUserID=getCookie("companyUserID")||1);var b=a.type||"GET",c=OBJ.URL;a.url&&(a.url.indexOf("role")>-1&&(c=c.replace("enterprise/","")),$.ajax({url:c+a.url,type:b,data:a.obj,dataType:"jsonp",success:function(b){1==b.code||1==b.ret?a.callback(b):$(".loading").html("暂无数据")},error:function(){$(".loading").html("暂无数据")}}))}}function bindEvent(){var c,d,a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c).attr("data-id",$(this).attr("data-id")),b.hide()}),c=$("span","div.tabs"),d=$("div.item","div.tabcon"),c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this),b=$("div.reg");b.removeClass("on"),"person"==a.attr("data-type")?b.eq(0).addClass("on"):b.eq(1).addClass("on")}),$("div.dialog,div.winpop").on("click","a.close",function(){$("div.dialog,div.winpop").hide()}).on("click","a.btn-cancel",function(){$("div.dialog,div.winpop").hide()})}function search(){$("div.search").on("click","a.btn-search",function(a,b,c){ajaxFn({url:a,obj:b,callback:c})})}function addTpl(a){var b=[],c=[],d=[],f=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>","<th>序号</th>",'<th ms-repeat="th">{{$val}}</th>',"<th>操作</th>","</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="30" style="height:150px;padding-top:50px;" ms-duplex="nodata"></td>',"</tr>",'<tr ms-repeat="tr">',"<td>{{$index+1}}</td>",'<td ms-repeat="th" ms-data="getkey($index,$key)">{{getkey($index,$key)}}</td>','<td><a class="edit-item" ms-href="getId($index)" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),f.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >',"<label>{{el.name}}：</label> ",'<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-data-id="el.id" ms-attr-data-id="el.id" ms-attr-value="el.value" ms-on-input="change"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-id="el.name" ms-attr-value="el.value">','<select class="select" ms-duplex="selected" ms-attr-id="el.id">','<option ms-repeat="el.option" >{{el}}</option>',"</select>","</span>",'<span ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-data-id="el.id" ms-attr-value="el.value" class="remark"></textarea></div>',"</span>","</script>"].join("")),f.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),f.append(d))}function getProcess(a){var c,d,b=null;for($("p",$process).removeClass("on over"),$process.append('<input id="processParam" type="hidden" data-param='+JSON.stringify(a).replace(/\"/g,"'")+" />"),c=1,d=$("p",$process).length;d>c;c++){if(b=$("p.step"+c,$process),console.log(a.processDetail+":"+b.attr("data-name")),a.processDetail==b.attr("data-name"))return b.addClass("on"),void 0;b.addClass("over")}}function changeProcess(index){var param=eval("("+$("#processParam").attr("data-param")+")");param.processParam=OBJ.STATUS[index],COMMON.ajaxFn({url:"saveOrUpdateProcessDetail.do",obj:param,callback:function(a){var b="";b=1==a.code?"修改成功":"修改失败",$dialog.dialog({title:"确认提示",content:b,button:[{text:"确认",cls:"btn-ok",handler:function(){$dialog.dialog("hide")}}],callback:function(a){if("修改成功"==b){for(var c=0,d=$("p",$process).length;d>c;c++)index>c&&($("p",$process).removeClass("on"),$("p.step"+c,$process).addClass("over"));$("p.step"+index,$process).addClass("on")}setTimeout(function(){a.dialog("hide")},2e3)}})}})}var gettype=Object.prototype.toString,OBJ={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","正修","已修","内部交车","结算","交车"],th0:{maintainfortNum:"维修单号",truename:"真实姓名",platenumber:"车牌号",phone:"电话",maintaintype:"类别",status:"状态"},th1:[]},defaultParam={facilitatorID:getCookie("facilitatorID")||1,companyUserID:getCookie("companyUserID")||1},navIndex=0,tableModel=null,href=document.location.href,$dialog=$("div.dialog"),$process=$("div.process");return $process.on("click","p",function(){var a=$(this),b=a.index()+1,c=$("div.dialog");a.hasClass("over")||a.hasClass("on")||c.dialog({title:"确认修改流程",content:"确定要修改到当前状态吗？",button:[{text:"确定",cls:"btn-ok",handler:function(a){var b=a.attr("data-id");changeProcess(b)}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(){var a=$("div.dialog");a.addClass("auto"),a.attr("data-id",b)}})}),{init:function(){domRender(),bindEvent()},OBJ:OBJ,table:tableInit,getTr:getTr,edit:editInit,addTpl:addTpl,ajaxFn:ajaxFn,search:search,getQuery:getQueryString,gettype:gettype,getCookie:getCookie,setCookie:setCookie,getProcess:getProcess,defaultParam:defaultParam}}();$(function(){COMMON.init()});