var COMMON=function(){function a(a,b){var c=30,d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3),document.cookie=a+"="+escape(b)+";expires="+d.toGMTString()}function b(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function c(a){if(-1===t.indexOf("?")||-1===t.indexOf(a+"="))return"";var b=t.substring(t.indexOf("?")+1);-1!==b.indexOf("#")&&(b=b.substring(0,b.indexOf("#")));for(var c,d,e,f=b.split("&"),g=0;g<f.length;g++)if(c=f[g].indexOf("="),-1!==c&&(d=f[g].substring(0,c),e=f[g].substring(c+1),d===a))return e.replace(/\+/g," ");return""}function d(){for(var a=["index","yuyuejiedai","weixiujiedai","weixiulingliao","chejianguanli","kufangguanli","kehuguanli","yonghuguanli","caiwuguanli","xitongguanli"],b=0,c=a.length;c>b;b++)t.indexOf(a[b])>0&&$("a","div.mainnav").removeClass("on").eq(b).addClass("on")}function e(a,b){var c=a.id||"table",d=a.param,e=a.id||"model";s=avalon.define(e,function(b){b.$id=c,b.itemId=a.itemId,b.th=a.th,b.tr=[],b.isOpt=a.isOpt===!1?!1:!0,b.nodata='<img src="img/loading.gif"/>',b.getkey=function(c,d){if(t.indexOf("index.html")>-1&&"state"==d)return'<img src="img/status'+(b.tr[c][d]||0)+'.png" />';if(b.tr.size()>0&&b.tr[c]){if(a.th[c].time){var e=b.tr[c][d];return new Date(e).toLocaleDateString()}return b.tr[c][d]}},b.getId=function(c,d){var e=b;if(e.tr.size()>0&&e.tr[c]&&1!=a.btntype){var f=t.split("/"),g=f[f.length-1].split(".html")[0]||"index";return g+"-opt.html?id="+e.tr[c][e.itemId]}},b.getNum=function(a){for(var b=$("tr",$("table.Mtable")),c=null,d=0,e=b.length;e>d;d++)b.eq(d).hasClass("loading")||(c=$("td",b.eq(d)).first(),c.html(parseInt(c.html())+10*(a-1)))},b.delItem=function(c){var e=b.tr[c][a.itemId],f={};u.dialog({title:"窗口提示",content:"确定删除此条数据吗？",button:[{text:"确定",cls:"btn-ok",handler:function(c){f[a.itemId]=e,f=$.extend({},r,f),j({url:a.delport,obj:f,callback:function(e){1==e.code&&(c.dialog("hide"),b.getTr(a.port,d,a.callback))}})}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})},b.addItem=function(){if(1==a.btntype)$("div.dialog").dialog("show"),"function"==typeof a.callback&&a.callback();else{var b=t.split("/"),c=b[b.length-1].split(".html")[0]||"index";t.indexOf("weixiujiedai")>-1?j({url:a.addport,obj:{},callback:function(a){1==a.code&&(location.href=c+"-opt.html?id="+a.data.mainId)}}):location.href=c+"-opt.html"}},b.getTr=function(){f(a.port,d,a.callback)},b.searchItem=function(){var c=$("div.search");d[$("span.select",c).attr("data-id")]=$("input.inpt-search",c).val(),b.getTr(a.port,d,a.callback)}}),avalon.scan()}function f(a,b,c){b=$.extend({},r,b||{}),curpage=b.pageNum,b.pageSize=10,j({url:a,obj:b,callback:function(d){if(1==d.code||1==d.ret){var e=d.data||{},f=null,h=$("tr.loading");if("[object Array]"==p.call(e)){if(!(e.length>0))return s.nodata="暂无数据",void h.show();f=e}else if("[object Object]"==p.call(e)){if(!d.data)return s.nodata="暂无数据",void h.show();if(!d.data.data)return s.nodata="暂无数据",void h.show();f=e.data||{}}if(h.hide(),t.indexOf("yuyuejiedai")>-1)for(var i,j=0,k=f.length;k>j;j++)i=f[j],i.maintainform&&(f[j]=$.extend({},i.maintainform||{},i));if(s.tr=[],s.tr=f||{},"function"==typeof c&&c(s),pageTotal=d.data.total||"",pageTotal){var l=pageTotal;$("div.page").pager({pageNumber:curpage,pageTotal:l,change:function(c){b.pageNum=c,g(a,b,function(){s.getNum(c)})}})}}}})}function g(a,b,c){f(a,b,c)}function h(a,b){var a=a||"edit",d=null,e={},f={status:0};t.indexOf("xitongguanli")>-1&&(f={}),f[b.itemId]=c("id"),c("id")&&(b.id&&(f[b.id]=c("id")),t.indexOf("kufangguanli")>-1&&(f=$.extend({},{pageNumber:1,pageSize:10},f)),j({url:b.editurl||b.editport,obj:f,callback:function(a){if(1==a.code){var f=b.editItem,g="",h=a.data||{};if(b.edittype&&(h=h.length>0?h[0]||{}:h.data[0]||{}),t.indexOf("yuyuejiedai")>-1&&(h=$.extend({},h.maintainform||{},h)),h){for(var i=0,j=f.length;j>i;i++)g=f[i].id,(t.indexOf("index")>-1||t.indexOf("weixiujiedai")>-1)&&"maintainfortNum"==g?(editItemVal=c("id"),d.item[i].value=editItemVal,e.mainId=editItemVal):(editItemVal=h[g],d.item[i].value=editItemVal,e[g]=editItemVal,f[i].option&&(d.selected=editItemVal));"function"==typeof b.callback&&b.callback(h)}}else $("div.opt").html(a.message||"数据不存在")}})),d=avalon.define({$id:a,item:b.editItem,newData:e,change:function(a){a.target.getAttribute("data-id")==b.itemId?e.mainId=a.target.value:e[a.target.getAttribute("data-id")]=a.target.value},data:[],dialogData:function(a,b){b&&(obj=$.extend({},r,b.param||{}),j({url:b.url,obj:obj,callback:function(b){if(1==b.code){var c=[];if(b.data){for(var d=b.data.data||{},f="",g=0,h=d.length;h>g;g++)f=d[g][a],c.push(['<span class="label">','<input type="radio" value="'+f+'" />'+f,"</span>"].join(""));$("div.dialog").dialog({title:"修改窗口",content:c.join(""),button:[{text:"确定",cls:"btn-ok",handler:function(b){$(".bd input",b);$("input[data-id="+a+"]").val($("input:checked",b).val()),e[a]=$("input:checked",b).val(),b.dialog("hide")}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("dialog-select")}})}}}}))},addItem:function(){var a=b.addurl||b.addport;if(a)j({url:a,obj:r,callback:function(a){if(1==a.code){var c=b.itemId,f=a.data||{};e={},e[c]=f[c]||"&nbsp;";for(var g=0,h=b.editItem.length;h>g;g++)b.editItem[g].value="";b.editItem[c]=f[c],d.item=b.editItem}}});else for(var c=0,f=b.editItem.length;f>c;c++)b.editItem[c].value="",e[b.editItem[c].name]=""},saveItem:function(){if(d.modifyId(),t.indexOf("kehuguanli-opt")>-1){var a={};a.id=c("id"),a.carOwner=e.carOwner,a.carNum=e.carNum,a.carType=e.carType,e=a}e[b.itemId]=c("id"),j({url:b.saveurl||b.saveport,type:"POST",obj:e,callback:function(a){1==a.code?$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存成功",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide"),c("type")?location.href=(t.substring(0,t.indexOf("-opt"))||"index")+".html?type="+c("type"):location.href=(t.substring(0,t.indexOf("-opt"))||"index")+".html"}}],callback:function(a){a.addClass("w400")}}):$("div.dialog-tips").dialog({title:"提示",content:a.message||"保存失败",button:[{text:"确定",cls:"btn-ok",handler:function(a){a.dialog("hide")}}],callback:function(a){a.addClass("w400")}})}})},cancelItem:function(){for(i in e)"maintainfortNum"==i&&(e.mainId=e[i],delete e[i]);j({url:b.cancelport,type:"POST",obj:e,callback:function(a){1==a.code?location.href=(t.substring(0,t.indexOf("-opt"))||"index")+".html":alert("取消失败")}})},modifyId:function(){(t.indexOf("index")>-1||t.indexOf("weixiujiedai")>-1)&&e.maintainfortNum&&(e.mainId=e.maintainfortNum),t.indexOf("chejianguanli")>-1&&e.appointmentNum&&(e.maintainID=e.appointmentNum)}})}function j(a){if(a){a.obj&&!a.obj.facilitatorID&&(a.obj.facilitatorID=b("facilitatorID")||1),a.obj&&!a.obj.companyUserID&&(a.obj.companyUserID=b("companyUserID")||1);var c=a.type||"GET",d=q.URL;a.url&&(a.url&&a.url.indexOf("role")>-1&&(d=d.replace("enterprise/","")),$.ajax({url:d+a.url,type:c,data:a.obj,dataType:"jsonp",success:function(b){1==b.code||1==b.ret?a.callback(b):$(".loading").html("暂无数据")},error:function(){$(".loading").html("暂无数据")}}))}}function k(){var a=$("div.search"),b=$("div.select-box",a);a.on("click","span.select",function(){b.show()}).on("click","div.select-box a",function(){var c=$(this).text();$("span.select",a).html(c).attr("data-id",$(this).attr("data-id")),b.hide()});var c=$("span","div.tabs"),d=$("div.item","div.tabcon");c.on("click",function(){var a=$(this),b=a.index();a.hasClass("on")||(c.removeClass("on").eq(b).addClass("on"),d.removeClass("on").eq(b).addClass("on"))}),$("input","div.user-type").on("click",function(){var a=$(this),b=$("div.reg");b.removeClass("on"),"person"==a.attr("data-type")?b.eq(0).addClass("on"):b.eq(1).addClass("on")}),$("div.dialog,div.winpop").on("click","a.close",function(){$("div.dialog,div.winpop").hide()}).on("click","a.btn-cancel",function(){$("div.dialog,div.winpop").hide()})}function l(a,b,c){$("div.search").on("click","a.btn-search",function(a,b,c){j({url:a,obj:b,callback:c})})}function m(a){var b=[],c=[],d=[],e=$("body");a.table&&$("#tpl").size()<1&&(b.push(['<script type="avalon" id="tpl">','<table class="Mtable">',"<thead>","<tr>",'<th width="80">序号</th>','<th ms-repeat="th" ms-attr-width="el.width">{{el.name}}</th>','<th ms-if-loop="isOpt" width="100">操作</th>',"</tr>","</thead>","<tbody>",'<tr class="loading">','<td colspan="30" style="height:150px;padding-top:50px;" ms-duplex="nodata"></td>',"</tr>",'<tr ms-repeat="tr">',"<td>{{$index+1}}</td>",'<td ms-repeat="th" ms-data-id="el.id" ms-html="getkey($outer.$index,el.id)"></td>','<td ms-if-loop="isOpt"><a class="edit-item" ms-href="getId($index)" >编辑</a><a href="javascript:;" ms-click="delItem($index)" class="delete-item"> 删除</a></td>',"</tr>","</tbody>","</table>","</script>"].join("")),e.append(b)),a.edit&&$("#edittpl").size()<1&&(c.push(['<script type="avalon" id="edittpl">','<div class="item" ms-class="allrow:el.type == 2" ms-repeat="item" >','<label><span class="fred"  ms-if-loop="el.ismust">* </span>{{el.name}}：</label> ','<span  ms-if="!el.type || el.type == 0"><input type="text" class="inpt" ms-data-id="el.id" ms-attr-data-id="el.id" ms-attr-value="el.value" ms-on-input="change" ms-click="dialogData(el.id,el.click)"  /></span>','<span ms-class="select-outer"  ms-if="el.type == 1" ms-attr-id="el.name" ms-attr-value="el.value">','<select class="select" ms-duplex="el.selected" ms-attr-id="el.id">','<option ms-repeat="el.options" ms-attr-value="el.value" >{{el.text}}</option>',"</select>","</span>",'<span ms-if="el.type == 2"><textarea  ms-on-input="change" ms-attr-data-id="el.id" ms-attr-value="el.value" class="remark"></textarea></div>',"</span>","</script>"].join("")),e.append(c)),a.total&&$("#totaltpl").size()<1&&(d.push(['<script type="avalon" id="totaltpl">','<div class="item" ms-repeat="item">',"<label>{{el.name}}：</label> {{el.val}}","</div>","</script>"].join("")),e.append(d))}function n(a){var b=null;j({url:"progressionBar.do",obj:{mainId:c("id")},callback:function(a){if(1==a.code){$("p",v).removeClass("on over");for(var c=1,d=$("p",v).length;d>c;c++){if(b=$("p.step"+c,v),a.data.processNum==b.attr("data-id"))return void b.addClass("on");b.addClass("over")}}}})}function o(a){var b={mainId:c("id"),processNum:a};COMMON.ajaxFn({url:"progressionBarSaveOrUpdate.do",obj:b,callback:function(b){var c="";c=1==b.code?"修改成功":"修改失败",u.dialog({title:"确认提示",content:c,button:[{text:"确认",cls:"btn-ok",handler:function(){u.dialog("hide")}}],callback:function(b){if("修改成功"==c){$("p",v).removeClass("on over");for(var d=0,e=$("p",v).length;e>d;d++)a>d&&$("p.step"+d,v).addClass("over");$("p.step"+a,v).addClass("on")}setTimeout(function(){b.dialog("hide")},2e3)}})}})}var p=Object.prototype.toString,q={URL:"http://115.159.77.210:8080/ybcl2.0/enterprise/",STATUS:["全部","预约","未修","正修","已修","内部交车","结算","交车"],CLASS:["保养","维修","美容"]},r={facilitatorID:b("facilitatorID")||1,companyUserID:b("companyUserID")||1},s=null,t=document.location.href,u=$("div.dialog"),v=$("div.process");return v.on("click","p",function(){var a=$(this),b=a.index()+1,c=$("div.dialog");c.dialog({title:"确认修改流程",content:"确定要修改到当前状态吗？",button:[{text:"确定",cls:"btn-ok",handler:function(a){var b=a.attr("data-id");o(b)}},{text:"取消",cls:"btn-cancel",handler:function(a){a.dialog("hide")}}],callback:function(){var a=$("div.dialog");a.addClass("auto"),a.attr("data-id",b)}})}),{init:function(){d(),k()},OBJ:q,table:e,getTr:f,edit:h,addTpl:m,ajaxFn:j,search:l,getQuery:c,gettype:p,getCookie:b,setCookie:a,getProcess:n,defaultParam:r}}();$(function(){COMMON.init()});